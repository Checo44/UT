<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Team Trader (30 Teams Mock Market)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- API KEY CONFIGURATION ---
        const apiKey = ""; // API Key provided by the environment

        // --- ICONS ---
        const IconBase = ({ children, className, size = 24, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></IconBase>;
        const TrendingDown = (props) => <IconBase {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17"></path><path d="M14 14.66V17"></path><path d="M12 2v20"></path><path d="M12 2a7 7 0 0 0-7 7c0 8.1 11.4 12 11.4 12S19 17.1 19 9a7 7 0 0 0-7-7z"></path></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></IconBase>;
        const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></IconBase>;
        const Send = (props) => <IconBase {...props}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></IconBase>;

        // --- LOGIC HELPERS ---
        const getTickSize = (price) => {
            if (price < 10) return 0.01;
            if (price < 50) return 0.05;
            if (price < 100) return 0.1;
            if (price < 500) return 0.5;
            if (price < 1000) return 1.0;
            return 5.0;
        };

        const calculateLimitUp = (refPrice) => {
            let target = refPrice * 1.10;
            const tick = getTickSize(target); 
            return Math.floor(target / tick) * tick;
        };

        const calculateLimitDown = (refPrice) => {
            let target = refPrice * 0.90;
            const tick = getTickSize(target);
            return Math.ceil(target / tick) * tick;
        };

        // FULL 30 MLB TEAMS
        const INITIAL_STOCKS_DATA = [
            // AL East
            { code: 'NYY', name: 'NY Yankees', refPrice: 1280.0 },
            { code: 'BAL', name: 'Baltimore Orioles', refPrice: 540.0 },
            { code: 'TB', name: 'Tampa Bay Rays', refPrice: 320.0 },
            { code: 'TOR', name: 'Toronto Blue Jays', refPrice: 420.0 },
            { code: 'BOS', name: 'Boston Red Sox', refPrice: 750.0 },
            // AL Central
            { code: 'MIN', name: 'Minnesota Twins', refPrice: 380.0 },
            { code: 'DET', name: 'Detroit Tigers', refPrice: 310.0 },
            { code: 'CLE', name: 'Cleveland Guardians', refPrice: 360.0 },
            { code: 'KC', name: 'KC Royals', refPrice: 290.0 },
            { code: 'CWS', name: 'Chi White Sox', refPrice: 150.0 },
            // AL West
            { code: 'HOU', name: 'Houston Astros', refPrice: 890.0 },
            { code: 'TEX', name: 'Texas Rangers', refPrice: 580.0 },
            { code: 'SEA', name: 'Seattle Mariners', refPrice: 450.0 },
            { code: 'LAA', name: 'LA Angels', refPrice: 340.0 },
            { code: 'OAK', name: 'Oakland Athletics', refPrice: 180.0 },
            // NL East
            { code: 'ATL', name: 'Atlanta Braves', refPrice: 920.0 },
            { code: 'PHI', name: 'Phila Phillies', refPrice: 760.0 },
            { code: 'MIA', name: 'Miami Marlins', refPrice: 220.0 },
            { code: 'NYM', name: 'NY Mets', refPrice: 610.0 },
            { code: 'WSH', name: 'Washington Nationals', refPrice: 280.0 },
            // NL Central
            { code: 'MIL', name: 'Milwaukee Brewers', refPrice: 350.0 },
            { code: 'CHC', name: 'Chi Cubs', refPrice: 580.0 },
            { code: 'CIN', name: 'Cincinnati Reds', refPrice: 260.0 },
            { code: 'PIT', name: 'Pittsburgh Pirates', refPrice: 240.0 },
            { code: 'STL', name: 'St. Louis Cardinals', refPrice: 480.0 },
            // NL West
            { code: 'LAD', name: 'LA Dodgers', refPrice: 1350.0 },
            { code: 'ARI', name: 'Arizona D-backs', refPrice: 390.0 },
            { code: 'SD', name: 'SD Padres', refPrice: 550.0 },
            { code: 'SF', name: 'SF Giants', refPrice: 590.0 },
            { code: 'COL', name: 'Colorado Rockies', refPrice: 210.0 },
        ];

        const INITIAL_STOCKS = INITIAL_STOCKS_DATA.map(s => {
            const limitUp = calculateLimitUp(s.refPrice);
            const limitDown = calculateLimitDown(s.refPrice);
            return {
                ...s,
                price: s.refPrice,
                volume: Math.floor(Math.random() * 20000) + 5000,
                high: s.refPrice,
                low: s.refPrice,
                change: 0,
                changePercent: 0,
                limitUp,
                limitDown
            };
        });

        const formatMoney = (num) => new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(num);
        const formatPercent = (num) => `${num > 0 ? '+' : ''}${num.toFixed(2)}%`;
        const getColorClass = (val) => val > 0 ? 'text-red-500' : val < 0 ? 'text-green-500' : 'text-gray-400';
        const getBgColorClass = (val) => val > 0 ? 'bg-red-500/10 text-red-500' : val < 0 ? 'bg-green-500/10 text-green-500' : 'bg-gray-700 text-gray-300';

        // --- GEMINI SERVICE ---
        const generateGeminiResponse = async (prompt) => {
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            // ENABLE GOOGLE SEARCH GROUNDING
                            tools: [{ google_search: {} }] 
                        }),
                    }
                );
                if (!response.ok) throw new Error('API call failed');
                const data = await response.json();
                
                // Extract text and potentially citations
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Analyst is currently offline.";
                return text;
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Êä±Ê≠âÔºåÂ∏ÇÂ†¥ÈÄ£Á∑ö‰∏çÁ©©ÂÆö (API Error)„ÄÇË´ãÁ®çÂæåÂÜçË©¶„ÄÇ";
            }
        };

        // --- AI ANALYST COMPONENT ---
        const AIAnalystModal = ({ isOpen, onClose, selectedStock, allStocks }) => {
            const [messages, setMessages] = useState([
                { role: 'system', text: "‰Ω†Â•ΩÔºÅÊàëÊòØÊÇ®ÁöÑ Gemini Â∏ÇÂ†¥ÂàÜÊûêÂ∏´„ÄÇÊàëÂèØ‰ª•Âπ´ÊÇ®ÂàÜÊûê MLB ÁêÉÈöäÁöÑ„ÄåËÇ°ÂÉπ„ÄçÔºå‰∏¶ÁµêÂêàÁúüÂØ¶‰∏ñÁïåÁöÑÊúÄÊñ∞Ê£íÁêÉÊñ∞ËÅûÁµ¶Âá∫Âª∫Ë≠∞„ÄÇË´ãÈö®ÊôÇÁôºÂïèÔºÅ" }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleSend = async (textOverride = null) => {
                const textToSend = textOverride || input;
                if (!textToSend.trim()) return;

                // Add user message
                setMessages(prev => [...prev, { role: 'user', text: textToSend }]);
                setInput('');
                setIsLoading(true);

                // Construct context-aware prompt
                let context = `
                ËßíËâ≤Ë®≠ÂÆöÔºö‰Ω†ÊòØ‰∏Ä‰ΩçÁ≤æÊòé‰∏îÂπΩÈªòÁöÑ„ÄåMLB ËÇ°Â∏ÇÂàÜÊûêÂ∏´„Äç„ÄÇÂú®ÈÄôÂÄãËôõÊì¨Â∏ÇÂ†¥‰∏≠ÔºåMLB ÁêÉÈöäÂÉèËÇ°Á•®‰∏ÄÊ®£Ë¢´‰∫§Êòì„ÄÇ
                
                Áï∂ÂâçÂ∏ÇÂ†¥Êï∏Êìö (ËôõÊì¨Êï∏Êìö)Ôºö
                - Ê®ôÁöÑÁêÉÈöäÔºö${selectedStock.name} (${selectedStock.code})
                - ÁèæÂÉπÔºö${selectedStock.price}
                - Êº≤Ë∑åÔºö${selectedStock.change > 0 ? '+' : ''}${selectedStock.change.toFixed(2)} (${formatPercent(selectedStock.changePercent)})
                - Êàê‰∫§ÈáèÔºö${selectedStock.volume}
                - ÂèÉËÄÉÂÉπ (Êò®Êî∂)Ôºö${selectedStock.refPrice}
                
                ‰ªªÂãôÊåá‰ª§Ôºö
                1. Ë´ãÂãôÂøÖ‰ΩøÁî® Google Search ÊêúÂ∞ãÈóúÊñº„Äå${selectedStock.name}„ÄçÁöÑ„ÄêÊúÄÊñ∞ÁúüÂØ¶‰∏ñÁïåÊñ∞ËÅû„Äë(‰æãÂ¶ÇÔºöÊúÄËøëÁöÑÊØîË≥ΩÂãùË≤†„ÄÅÁêÉÂì°ÂèóÂÇ∑„ÄÅ‰∫§ÊòìÂÇ≥ËÅû„ÄÅÊéíÂêçÁãÄÊ≥Å)„ÄÇ
                2. Â∞á„ÄêÁúüÂØ¶Êñ∞ËÅû„ÄëËàá‰∏äÊñπÁöÑ„ÄêËôõÊì¨ËÇ°ÂÉπÊï∏Êìö„ÄëÁµêÂêàÈÄ≤Ë°åÂàÜÊûê„ÄÇ
                3. Â¶ÇÊûúÁêÉÈöäÂú®ÁúüÂØ¶‰∏ñÁïåË°®ÁèæÂ•ΩÔºàÈÄ£Âãù„ÄÅÁêÉÊòüË°®ÁèæÂÑ™Áï∞ÔºâÔºåË´ãÁµ¶Âá∫„ÄåÁúãÂ§ö (Bullish)„ÄçÁöÑÂª∫Ë≠∞Ôºå‰∏¶Ëß£ÈáãÁÇ∫ËÇ°ÂÉπ‰∏äÊº≤ÁöÑÂéüÂõ†„ÄÇ
                4. Â¶ÇÊûúÁêÉÈöäÂú®ÁúüÂØ¶‰∏ñÁïåË°®ÁèæÂ∑ÆÔºàÈÄ£Êïó„ÄÅÂèóÂÇ∑ÔºâÔºåË´ãÁµ¶Âá∫„ÄåÁúãÁ©∫ (Bearish)„ÄçÁöÑÂª∫Ë≠∞Ôºå‰∏¶Ëß£ÈáãÁÇ∫‰ΩïËÇ°ÂÉπÂèØËÉΩ‰∏ãË∑å„ÄÇ
                5. Ë´ãÁî®„ÄêÁπÅÈ´î‰∏≠Êñá„ÄëÂõûÁ≠îÔºåË™ûÊ∞£ÂèØ‰ª•Â∏∂ÈªûÂπΩÈªòÊàñÊ£íÁêÉË°ìË™û„ÄÇ
                
                ‰ΩøÁî®ËÄÖÂïèÈ°åÔºö${textToSend}
                ÂàÜÊûêÂ∏´ÂõûÊáâÔºö`;

                const responseText = await generateGeminiResponse(context);

                setMessages(prev => [...prev, { role: 'ai', text: responseText }]);
                setIsLoading(false);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 w-full max-w-lg h-[600px] rounded-2xl shadow-2xl border border-gray-600 flex flex-col overflow-hidden relative">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-4 flex justify-between items-center">
                            <div className="flex items-center text-white font-bold text-lg">
                                <Sparkles className="mr-2 text-yellow-300 animate-pulse" />
                                Gemini Êô∫ËÉΩÂàÜÊûêÂ∏´
                            </div>
                            <button onClick={onClose} className="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-1 transition">
                                <XCircle size={24} />
                            </button>
                        </div>

                        {/* Chat Area */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900/90">
                            {messages.map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] rounded-2xl px-4 py-3 text-sm leading-relaxed shadow-sm ${
                                        msg.role === 'user' 
                                            ? 'bg-blue-600 text-white rounded-tr-none' 
                                            : 'bg-gray-700 text-gray-100 rounded-tl-none border border-gray-600'
                                    }`}>
                                        {/* Basic markdown-like rendering for bold text */}
                                        {msg.text.split('\n').map((line, i) => (
                                            <p key={i} className="mb-1 last:mb-0">{line}</p>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="flex justify-start">
                                    <div className="bg-gray-700 text-gray-400 rounded-2xl px-4 py-3 text-sm rounded-tl-none flex items-center space-x-2">
                                        <span className="text-xs mr-2">ÊêúÂ∞ãÁúüÂØ¶Êñ∞ËÅû‰∏≠...</span>
                                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Quick Actions */}
                        <div className="p-2 bg-gray-800 border-t border-gray-700 flex space-x-2 overflow-x-auto no-scrollbar">
                            <button 
                                onClick={() => handleSend(`Ë´ãÂàÜÊûê ${selectedStock.name} (${selectedStock.code}) ÁöÑÊúÄÊñ∞Ëµ∞Âã¢„ÄÇ`)}
                                disabled={isLoading}
                                className="whitespace-nowrap px-3 py-1.5 bg-purple-900/50 text-purple-300 text-xs rounded-full border border-purple-700/50 hover:bg-purple-800/50 transition"
                            >
                                ‚ú® ÂàÜÊûê {selectedStock.code}
                            </button>
                            <button 
                                onClick={() => handleSend("ÁèæÂú®Â§ßËÅØÁõüÁöÑÊï¥È´îÂ∏ÇÂ†¥ÊÉÖÁ∑íÂ¶Ç‰ΩïÔºüÂì™ÈöäÊúÄÂº∑Ôºü")}
                                disabled={isLoading}
                                className="whitespace-nowrap px-3 py-1.5 bg-blue-900/50 text-blue-300 text-xs rounded-full border border-blue-700/50 hover:bg-blue-800/50 transition"
                            >
                                üìà Â∏ÇÂ†¥Á∏ΩË¶Ω
                            </button>
                            <button 
                                onClick={() => handleSend("Ë¨õÂÄãÈóúÊñºÊ£íÁêÉÁöÑÁ¨ëË©±‰æÜËÅΩËÅΩ„ÄÇ")}
                                disabled={isLoading}
                                className="whitespace-nowrap px-3 py-1.5 bg-green-900/50 text-green-300 text-xs rounded-full border border-green-700/50 hover:bg-green-800/50 transition"
                            >
                                ‚öæ Ë¨õÂÄãÁ¨ëË©±
                            </button>
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-gray-800 border-t border-gray-700">
                            <div className="flex items-center space-x-2 relative">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                    placeholder="Ëº∏ÂÖ•ÂïèÈ°å (‰æãÂ¶Ç: Ê¥ãÂü∫ÈöäÊúÄËøëÊà∞Á∏æÂ¶Ç‰ΩïÂΩ±ÈüøËÇ°ÂÉπ?)"
                                    disabled={isLoading}
                                    className="w-full bg-gray-900 border border-gray-600 rounded-full pl-4 pr-12 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition text-white placeholder-gray-500"
                                />
                                <button 
                                    onClick={() => handleSend()}
                                    disabled={isLoading || !input.trim()}
                                    className="absolute right-2 p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg"
                                >
                                    <Send size={16} />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [marketOpen, setMarketOpen] = useState(true);
            const [stocks, setStocks] = useState(INITIAL_STOCKS);
            const [selectedStockCode, setSelectedStockCode] = useState('LAD');
            const [isAnalystOpen, setIsAnalystOpen] = useState(false);
            
            const [account, setAccount] = useState({
                cash: 10000000, 
                totalAssets: 10000000,
                realizedPL: 0,
            });
            const [positions, setPositions] = useState([]);
            const [orders, setOrders] = useState([]);
            
            // Form State
            const [orderSide, setOrderSide] = useState('BUY');
            const [orderType, setOrderType] = useState('LIMIT');
            const [orderCondition, setOrderCondition] = useState('ROD');
            const [orderPrice, setOrderPrice] = useState('');
            const [orderQty, setOrderQty] = useState('1000'); 
            const [notification, setNotification] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            // --- MARKET ENGINE ---
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                    
                    if (marketOpen) {
                        setStocks(prevStocks => prevStocks.map(stock => {
                            if (Math.random() > 0.7) { // slightly less volatility for 30 teams to avoid chaos
                                const direction = Math.random() > 0.5 ? 1 : -1;
                                const tick = getTickSize(stock.price);
                                const tickMult = Math.floor(Math.random() * 2) + 1;
                                let newPrice = stock.price + (direction * tick * tickMult);
                                
                                if (newPrice > stock.limitUp) newPrice = stock.limitUp;
                                if (newPrice < stock.limitDown) newPrice = stock.limitDown;
                                
                                const newHigh = Math.max(stock.high, newPrice);
                                const newLow = Math.min(stock.low, newPrice);
                                const newChange = newPrice - stock.refPrice;
                                const newChangePercent = (newChange / stock.refPrice) * 100;
                                const volAdd = Math.floor(Math.random() * 30); 

                                return {
                                    ...stock,
                                    price: parseFloat(newPrice.toFixed(2)),
                                    high: newHigh,
                                    low: newLow,
                                    change: newChange,
                                    changePercent: newChangePercent,
                                    volume: stock.volume + volAdd
                                };
                            }
                            return stock;
                        }));
                    }
                }, 2000);

                return () => clearInterval(timer);
            }, [marketOpen]);

            // --- MATCHING ENGINE ---
            useEffect(() => {
                if (!marketOpen) return;

                setOrders(prevOrders => {
                    let hasUpdates = false;
                    const updatedOrders = prevOrders.map(order => {
                        if (order.status !== 'PENDING') return order;

                        const currentStock = stocks.find(s => s.code === order.code);
                        if (!currentStock) return order;

                        let isMatch = false;
                        if (order.side === 'BUY' && order.type === 'LIMIT' && currentStock.price <= order.price) isMatch = true;
                        if (order.side === 'SELL' && order.type === 'LIMIT' && currentStock.price >= order.price) isMatch = true;

                        if (isMatch) {
                            hasUpdates = true;
                            executeTrade(order, currentStock.price, order.quantity);
                            return { ...order, status: 'FILLED', filledQuantity: order.quantity, averageFillPrice: currentStock.price };
                        }
                        return order;
                    });

                    return hasUpdates ? updatedOrders : prevOrders;
                });
            }, [stocks, marketOpen]);

            // --- PORTFOLIO UPDATE ---
            useEffect(() => {
                setPositions(prev => prev.map(pos => {
                    const stock = stocks.find(s => s.code === pos.code);
                    if (!stock) return pos;
                    
                    const marketValue = Math.abs(pos.quantity) * stock.price;
                    let unrealizedPL = 0;
                    
                    if (pos.quantity > 0) {
                        unrealizedPL = (stock.price - pos.averageCost) * pos.quantity;
                    } else {
                        unrealizedPL = (pos.averageCost - stock.price) * Math.abs(pos.quantity);
                    }

                    const costBasis = Math.abs(pos.quantity) * pos.averageCost;
                    const unrealizedPLPercent = costBasis === 0 ? 0 : (unrealizedPL / costBasis) * 100;

                    return { ...pos, currentPrice: stock.price, marketValue, unrealizedPL, unrealizedPLPercent };
                }));
            }, [stocks]);

            useEffect(() => {
                const totalUnrealized = positions.reduce((acc, p) => acc + p.unrealizedPL, 0);
                const initialCash = 10000000;
                const netLiq = initialCash + account.realizedPL + totalUnrealized;
                setAccount(prev => ({ ...prev, totalAssets: netLiq }));
            }, [positions, account.cash, account.realizedPL]);

            // --- ACTIONS ---
            const executeTrade = (order, fillPrice, fillQty) => {
                const tradeAmount = fillPrice * fillQty;
                const fee = Math.floor(tradeAmount * 0.001425);
                const tax = order.side === 'SELL' ? Math.floor(tradeAmount * 0.003) : 0;
                const netCashChange = order.side === 'BUY' ? -(tradeAmount + fee) : (tradeAmount - fee - tax);
                let realizedGain = 0;
                
                setPositions(prev => {
                    const existing = prev.find(p => p.code === order.code);
                    
                    if (!existing) {
                        const signedQty = order.side === 'BUY' ? fillQty : -fillQty;
                        return [...prev, {
                            code: order.code,
                            name: order.name,
                            quantity: signedQty,
                            averageCost: fillPrice,
                            currentPrice: fillPrice,
                            marketValue: tradeAmount,
                            unrealizedPL: -fee - tax,
                            unrealizedPLPercent: 0
                        }];
                    } else {
                        let newPositions = [...prev];
                        let newQty = existing.quantity;
                        let newAvgCost = existing.averageCost;

                        const isAddingLong = existing.quantity > 0 && order.side === 'BUY';
                        const isAddingShort = existing.quantity < 0 && order.side === 'SELL';

                        if (isAddingLong || isAddingShort) {
                            const signedFillQty = order.side === 'BUY' ? fillQty : -fillQty;
                            const totalVal = (Math.abs(existing.quantity) * existing.averageCost) + tradeAmount;
                            newQty = existing.quantity + signedFillQty;
                            newAvgCost = totalVal / Math.abs(newQty);
                            
                            newPositions = prev.map(p => p.code === order.code ? {
                                ...p, quantity: newQty, averageCost: newAvgCost
                            } : p);
                        } 
                        else {
                            const closeQty = fillQty;
                            if (existing.quantity > 0) {
                                realizedGain = (fillPrice - existing.averageCost) * closeQty - fee - tax;
                                newQty = existing.quantity - closeQty;
                            } else {
                                realizedGain = (existing.averageCost - fillPrice) * closeQty - fee;
                                newQty = existing.quantity + closeQty;
                            }

                            if (Math.abs(newQty) < 0.0001) {
                                newPositions = prev.filter(p => p.code !== order.code);
                            } else {
                                newPositions = prev.map(p => p.code === order.code ? {
                                    ...p, quantity: newQty
                                } : p);
                            }
                        }
                        return newPositions;
                    }
                });

                setAccount(prev => {
                     const existing = positions.find(p => p.code === order.code);
                     let tradeRealizedPL = 0;
                     if (existing) {
                         const isClosingLong = existing.quantity > 0 && order.side === 'SELL';
                         const isClosingShort = existing.quantity < 0 && order.side === 'BUY';
                         if (isClosingLong) {
                             tradeRealizedPL = (fillPrice - existing.averageCost) * fillQty - fee - tax;
                         } else if (isClosingShort) {
                             tradeRealizedPL = (existing.averageCost - fillPrice) * fillQty - fee;
                         }
                     }
                     return {
                         ...prev,
                         cash: prev.cash + netCashChange,
                         realizedPL: prev.realizedPL + tradeRealizedPL
                     };
                });
                showNotification(`Trade Executed: ${order.side} ${order.code}`, 'success');
            };

            const handleSubmitOrder = (e) => {
                e.preventDefault();
                const stock = stocks.find(s => s.code === selectedStockCode);
                if (!stock) return;

                const price = orderType === 'MARKET' ? stock.price : parseFloat(orderPrice);
                const qty = parseInt(orderQty);

                if (!qty || qty <= 0) return showNotification('Invalid quantity', 'error');
                if (orderType === 'LIMIT') {
                    if (!price || price <= 0) return showNotification('Invalid price', 'error');
                    if (price > stock.limitUp) return showNotification(`Price exceeds Limit Up (${stock.limitUp})`, 'error');
                    if (price < stock.limitDown) return showNotification(`Price below Limit Down (${stock.limitDown})`, 'error');
                    
                    const tick = getTickSize(price);
                    const remainder = (price * 100) % (tick * 100);
                    if (Math.abs(remainder) > 0.001 && Math.abs(remainder - (tick*100)) > 0.001) {
                        return showNotification(`Invalid Tick Size. For ${price}, tick is ${tick}.`, 'error');
                    }
                }

                const pos = positions.find(p => p.code === selectedStockCode);
                const currentQty = pos ? pos.quantity : 0;
                const tradeVal = price * qty * 1.002;
                
                if (orderSide === 'BUY') {
                    if (currentQty < 0) {
                         if (qty > Math.abs(currentQty)) return showNotification(`Cannot cover more than short position (${Math.abs(currentQty)})`, 'error');
                    } else {
                         if (tradeVal > account.cash) return showNotification('Insufficient Cash to Buy', 'error');
                    }
                } 
                else if (orderSide === 'SELL') {
                    if (currentQty > 0) {
                        if (qty > currentQty) return showNotification(`Insufficient shares to sell (Hold: ${currentQty})`, 'error');
                    } else {
                        if (tradeVal > account.cash) return showNotification('Insufficient Cash Margin for Short', 'error');
                    }
                }

                const newOrder = {
                    id: Math.random().toString(36).substr(2, 9),
                    time: new Date().toLocaleTimeString('en-GB'),
                    code: stock.code,
                    name: stock.name,
                    side: orderSide,
                    type: orderType,
                    condition: orderCondition,
                    price: price,
                    quantity: qty,
                    filledQuantity: 0,
                    status: 'PENDING',
                    averageFillPrice: 0
                };

                const canFillNow = orderType === 'MARKET' || 
                    (orderSide === 'BUY' && stock.price <= price) || 
                    (orderSide === 'SELL' && stock.price >= price);

                if (orderCondition === 'IOC') {
                    if (canFillNow) {
                        executeTrade(newOrder, stock.price, qty);
                        setOrders(prev => [ { ...newOrder, status: 'FILLED', filledQuantity: qty, averageFillPrice: stock.price }, ...prev]);
                    } else {
                        setOrders(prev => [ { ...newOrder, status: 'CANCELLED' }, ...prev]);
                        showNotification('IOC Order Cancelled (No match)', 'info');
                    }
                } 
                else if (orderCondition === 'FOK') {
                    if (canFillNow) {
                        executeTrade(newOrder, stock.price, qty);
                        setOrders(prev => [ { ...newOrder, status: 'FILLED', filledQuantity: qty, averageFillPrice: stock.price }, ...prev]);
                    } else {
                        setOrders(prev => [ { ...newOrder, status: 'CANCELLED' }, ...prev]);
                        showNotification('FOK Order Killed (No match)', 'info');
                    }
                } 
                else {
                    if (canFillNow && orderType === 'MARKET') {
                        executeTrade(newOrder, stock.price, qty);
                        setOrders(prev => [ { ...newOrder, status: 'FILLED', filledQuantity: qty, averageFillPrice: stock.price }, ...prev]);
                    } else {
                        showNotification('Order Placed (ROD)', 'success');
                        setOrders(prev => [newOrder, ...prev]);
                    }
                }
            };

            const cancelOrder = (id) => {
                setOrders(prev => prev.map(o => o.id === id && o.status === 'PENDING' ? { ...o, status: 'CANCELLED' } : o));
                showNotification('Order Cancelled', 'success');
            };

            const showNotification = (msg, type) => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const selectedStock = stocks.find(s => s.code === selectedStockCode) || stocks[0];
            const currentPos = positions.find(p => p.code === selectedStockCode);

            const filteredStocks = stocks.filter(s => 
                s.code.toLowerCase().includes(searchTerm.toLowerCase()) || 
                s.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const renderOrderBook = () => {
                const tick = getTickSize(selectedStock.price);
                return (
                    <div className="grid grid-cols-2 gap-1 text-xs font-mono">
                        <div className="text-center text-gray-500 border-b border-gray-700 pb-1">BID (Buying)</div>
                        <div className="text-center text-gray-500 border-b border-gray-700 pb-1">ASK (Selling)</div>
                        
                        {[4,3,2,1,0].map(i => {
                            const p = selectedStock.price + (i+1) * tick;
                            return (
                                <React.Fragment key={`ask-${i}`}>
                                    <div className="bg-gray-800/30"></div>
                                    <div className="text-red-400 px-2 py-1 flex justify-between bg-red-900/20 cursor-pointer hover:bg-red-900/40" onClick={() => setOrderPrice(p.toFixed(2))}>
                                        <span>{p.toFixed(2)}</span>
                                        <span>{Math.floor(Math.random() * 50) + 1}</span>
                                    </div>
                                </React.Fragment>
                            )
                        })}

                        <div className="col-span-2 bg-gray-700 text-center py-1 text-white font-bold border-y border-yellow-500/30 flex justify-between px-4">
                            <span>{selectedStock.limitDown.toFixed(2)} ‚ñº</span>
                            <span>{selectedStock.price.toFixed(2)}</span>
                            <span>‚ñ≤ {selectedStock.limitUp.toFixed(2)}</span>
                        </div>

                        {[0,1,2,3,4].map(i => {
                            const p = selectedStock.price - (i+1) * tick;
                            return (
                                <React.Fragment key={`bid-${i}`}>
                                    <div className="text-green-400 px-2 py-1 flex justify-between bg-green-900/20 cursor-pointer hover:bg-green-900/40" onClick={() => setOrderPrice(p.toFixed(2))}>
                                        <span>{Math.floor(Math.random() * 50) + 1}</span>
                                        <span>{p.toFixed(2)}</span>
                                    </div>
                                    <div className="bg-gray-800/30"></div>
                                </React.Fragment>
                            )
                        })}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 font-sans flex flex-col overflow-hidden relative">
                    {/* HEADER */}
                    <header className="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md flex-shrink-0">
                        <div className="flex items-center space-x-2">
                            <Trophy className="text-yellow-500" />
                            <h1 className="text-xl font-bold tracking-wider">MLB Team Trader <span className="text-xs text-gray-500 font-normal ml-2 hidden sm:inline">Mock Market</span></h1>
                        </div>

                        <div className="flex items-center space-x-6 text-sm">
                            <div className="flex flex-col items-end">
                                <span className="text-gray-400 text-xs sm:text-sm">Market Status</span>
                                <span className={`font-bold text-xs sm:text-sm ${marketOpen ? 'text-green-400' : 'text-red-400'}`}>{marketOpen ? 'OPEN' : 'CLOSED'}</span>
                            </div>
                            <div className="hidden sm:flex flex-col items-end w-32">
                                <span className="text-gray-400 flex items-center"><Clock size={12} className="mr-1"/> Time</span>
                                <span className="font-mono">{currentTime.toLocaleTimeString()}</span>
                            </div>
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                        
                        {/* LEFT: MARKET LIST (Responsive: Column on mobile, Sidebar on Desktop) */}
                        <aside className="w-full md:w-1/4 md:min-w-[300px] h-64 md:h-auto bg-gray-800 border-b md:border-b-0 md:border-r border-gray-700 flex flex-col flex-shrink-0">
                            <div className="p-3 border-b border-gray-700">
                                <div className="relative">
                                    <Search className="absolute left-2 top-2.5 text-gray-500" size={16} />
                                    <input 
                                        type="text" 
                                        placeholder="Search Team..." 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full bg-gray-900 border border-gray-700 rounded pl-8 py-2 text-sm focus:outline-none focus:border-blue-500 transition" 
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead className="text-xs text-gray-500 bg-gray-900 sticky top-0 z-10">
                                        <tr>
                                            <th className="p-3">Team</th>
                                            <th className="p-3 text-right">Price</th>
                                            <th className="p-3 text-right">Chg %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredStocks.map(stock => (
                                            <tr 
                                                key={stock.code} 
                                                onClick={() => setSelectedStockCode(stock.code)}
                                                className={`cursor-pointer border-b border-gray-700 hover:bg-gray-700 transition ${selectedStockCode === stock.code ? 'bg-blue-900/30 border-l-4 border-l-blue-500' : ''}`}
                                            >
                                                <td className="p-3">
                                                    <div className="font-bold text-white">{stock.code}</div>
                                                    <div className="text-xs text-gray-400 truncate w-24 md:w-32">{stock.name}</div>
                                                </td>
                                                <td className={`p-3 text-right font-mono ${getColorClass(stock.change)}`}>
                                                    {formatMoney(stock.price)}
                                                </td>
                                                <td className={`p-3 text-right text-xs font-bold ${getBgColorClass(stock.change)} rounded`}>
                                                    {formatPercent(stock.changePercent)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </aside>

                        {/* CENTER: TRADING DESK */}
                        <main className="flex-1 flex flex-col bg-gray-900 overflow-y-auto pb-20 md:pb-0">
                            {/* TOP: Stock Info */}
                            <div className="p-6 border-b border-gray-800 bg-gray-800/50 flex-shrink-0">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div>
                                        <h2 className="text-3xl font-bold flex items-center">
                                            {selectedStock.name} <span className="text-xl text-gray-500 ml-2 font-normal">({selectedStock.code})</span>
                                        </h2>
                                        <div className="flex items-baseline mt-2 space-x-4">
                                            <span className={`text-4xl font-mono font-bold ${getColorClass(selectedStock.change)}`}>{selectedStock.price.toFixed(2)}</span>
                                            <div className={`flex items-center ${getColorClass(selectedStock.change)}`}>
                                                {selectedStock.change > 0 ? <TrendingUp size={20} className="mr-1"/> : <TrendingDown size={20} className="mr-1"/>}
                                                <span className="text-lg font-bold">{selectedStock.change > 0 ? '+' : ''}{selectedStock.change.toFixed(2)} ({formatPercent(selectedStock.changePercent)})</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-x-8 gap-y-2 text-sm text-gray-400 mt-4 md:mt-0">
                                        <div>Vol: <span className="text-white font-mono">{selectedStock.volume.toLocaleString()}</span></div>
                                        <div>Limit Up: <span className="text-red-500 font-mono">{selectedStock.limitUp.toFixed(2)}</span></div>
                                        <div>Ref: <span className="text-white font-mono">{selectedStock.refPrice.toFixed(2)}</span></div>
                                        <div>Limit Down: <span className="text-green-500 font-mono">{selectedStock.limitDown.toFixed(2)}</span></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 flex flex-col md:flex-row p-4 gap-4">
                                
                                {/* ORDER ENTRY */}
                                <div className="w-full md:w-1/2 bg-gray-800 rounded-lg p-5 shadow-lg h-fit">
                                    <h3 className="text-gray-300 font-bold mb-4 flex items-center"><Activity size={18} className="mr-2"/> Place Order</h3>
                                    
                                    {/* Position Status Indicator */}
                                    <div className="mb-4 text-xs">
                                         {currentPos ? (
                                             currentPos.quantity > 0 ? 
                                             <span className="bg-red-500/20 text-red-400 px-2 py-1 rounded">Current Pos: LONG {currentPos.quantity}</span> :
                                             <span className="bg-green-500/20 text-green-400 px-2 py-1 rounded">Current Pos: SHORT {Math.abs(currentPos.quantity)}</span>
                                         ) : (
                                             <span className="bg-gray-700 text-gray-400 px-2 py-1 rounded">Current Pos: None</span>
                                         )}
                                    </div>

                                    <form onSubmit={handleSubmitOrder} className="space-y-4">
                                        
                                        {/* Side Selector */}
                                        <div className="flex rounded-md overflow-hidden bg-gray-900 border border-gray-700">
                                            <button 
                                                type="button"
                                                onClick={() => setOrderSide('BUY')}
                                                className={`flex-1 py-2 font-bold transition ${orderSide === 'BUY' ? 'bg-red-600 text-white' : 'text-gray-500 hover:bg-gray-700'}`}
                                            >
                                                Buy / Cover
                                            </button>
                                            <button 
                                                type="button"
                                                onClick={() => setOrderSide('SELL')}
                                                className={`flex-1 py-2 font-bold transition ${orderSide === 'SELL' ? 'bg-green-600 text-white' : 'text-gray-500 hover:bg-gray-700'}`}
                                            >
                                                Sell / Short
                                            </button>
                                        </div>

                                        {/* Order Type & Condition */}
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Type</label>
                                                <select 
                                                    value={orderType} 
                                                    onChange={(e) => setOrderType(e.target.value)}
                                                    className="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm focus:border-blue-500 outline-none"
                                                >
                                                    <option value="LIMIT">Limit (ÈôêÂÉπ)</option>
                                                    <option value="MARKET">Market (Â∏ÇÂÉπ)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Condition</label>
                                                <select 
                                                    value={orderCondition} 
                                                    onChange={(e) => setOrderCondition(e.target.value)}
                                                    className="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm focus:border-blue-500 outline-none"
                                                >
                                                    <option value="ROD">ROD (Rest of Day)</option>
                                                    <option value="IOC">IOC (Imm. or Cancel)</option>
                                                    <option value="FOK">FOK (Fill or Kill)</option>
                                                </select>
                                            </div>
                                        </div>

                                        {/* Quantity */}
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">Quantity (Contracts)</label>
                                            <div className="relative">
                                                <input 
                                                    type="number" 
                                                    min="1"
                                                    step="1000"
                                                    value={orderQty} 
                                                    onChange={(e) => setOrderQty(e.target.value)}
                                                    className="w-full bg-gray-900 border border-gray-600 rounded p-2 text-right font-mono focus:border-blue-500 outline-none"
                                                />
                                                <span className="absolute left-3 top-2 text-gray-500 text-xs">1 Lot = 1000</span>
                                            </div>
                                        </div>

                                        {/* Price */}
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">Price (NT$)</label>
                                            <input 
                                                type="number" 
                                                disabled={orderType === 'MARKET'}
                                                value={orderType === 'MARKET' ? '' : orderPrice} 
                                                onChange={(e) => setOrderPrice(e.target.value)}
                                                placeholder={orderType === 'MARKET' ? 'Market Price' : selectedStock.price.toString()}
                                                className={`w-full bg-gray-900 border border-gray-600 rounded p-2 text-right font-mono focus:border-blue-500 outline-none ${orderType === 'MARKET' ? 'cursor-not-allowed opacity-50' : ''}`}
                                            />
                                            {orderType === 'LIMIT' && (
                                                <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span onClick={() => setOrderPrice(selectedStock.limitDown.toFixed(2))} className="cursor-pointer hover:text-green-400">Min: {selectedStock.limitDown}</span>
                                                    <span onClick={() => setOrderPrice(selectedStock.limitUp.toFixed(2))} className="cursor-pointer hover:text-red-400">Max: {selectedStock.limitUp}</span>
                                                </div>
                                            )}
                                        </div>

                                        {/* Summary */}
                                        <div className="bg-gray-900/50 p-3 rounded text-xs text-gray-400 flex justify-between items-center">
                                            <span>Est. Total:</span>
                                            <span className="text-white font-mono text-lg">
                                                {orderType === 'MARKET' 
                                                    ? `~${formatMoney(selectedStock.price * parseInt(orderQty || '0'))}`
                                                    : formatMoney(parseFloat(orderPrice || '0') * parseInt(orderQty || '0'))
                                                }
                                            </span>
                                        </div>

                                        <button 
                                            type="submit"
                                            className={`w-full py-3 rounded font-bold text-white shadow-lg transform transition hover:scale-[1.02] active:scale-95 ${orderSide === 'BUY' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}
                                        >
                                            {orderSide === 'BUY' ? 'BUY' : 'SELL'} {selectedStock.code}
                                        </button>
                                    </form>
                                </div>

                                {/* ORDER BOOK VISUALIZATION */}
                                <div className="w-full md:w-1/2 bg-gray-800 rounded-lg p-5 shadow-lg h-fit">
                                    <h3 className="text-gray-300 font-bold mb-4 text-sm uppercase tracking-wide">Order Book (5-Best)</h3>
                                    {renderOrderBook()}
                                    <div className="mt-4 pt-4 border-t border-gray-700">
                                        <h4 className="text-xs text-gray-400 mb-2">Recent Trades</h4>
                                        <div className="space-y-1">
                                            {[1,2,3].map(i => (
                                                <div key={i} className="flex justify-between text-xs font-mono">
                                                    <span className="text-gray-500">{new Date().toLocaleTimeString()}</span>
                                                    <span className={Math.random() > 0.5 ? 'text-red-500' : 'text-green-500'}>
                                                        {(selectedStock.price + (Math.random()-0.5)).toFixed(2)}
                                                    </span>
                                                    <span className="text-gray-300">{Math.floor(Math.random()*10)+1}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                            </div>

                            {/* BOTTOM: USER TABS */}
                            <div className="mt-2 bg-gray-800 border-t border-gray-700 flex-1 min-h-[300px]">
                                <div className="flex border-b border-gray-700 overflow-x-auto">
                                    <div className="px-6 py-3 text-sm font-bold border-b-2 border-blue-500 text-white whitespace-nowrap">Positions</div>
                                    <div className="px-6 py-3 text-sm font-bold text-gray-400 hover:text-white cursor-not-allowed whitespace-nowrap">Active Orders</div>
                                    <div className="px-6 py-3 text-sm font-bold text-gray-400 hover:text-white cursor-not-allowed whitespace-nowrap">History</div>
                                </div>

                                <div className="p-0">
                                    {/* Portfolio Summary Bar */}
                                    <div className="bg-gray-900 p-4 grid grid-cols-3 gap-4 border-b border-gray-800">
                                        <div>
                                            <div className="text-xs text-gray-500">Total Assets</div>
                                            <div className="text-base md:text-xl font-mono text-white font-bold truncate">{formatMoney(account.totalAssets)}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">Cash Balance</div>
                                            <div className="text-base md:text-xl font-mono text-blue-400 truncate">{formatMoney(account.cash)}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">Realized P/L</div>
                                            <div className={`text-base md:text-xl font-mono truncate ${getColorClass(account.realizedPL)}`}>{formatMoney(account.realizedPL)}</div>
                                        </div>
                                    </div>

                                    {/* Active Orders Table */}
                                    <div className="p-4 overflow-x-auto">
                                        <h3 className="text-gray-400 text-xs font-bold mb-2 uppercase">Pending Orders (ROD)</h3>
                                        <table className="w-full text-sm text-left text-gray-300 mb-8 min-w-[600px]">
                                            <thead className="text-xs text-gray-500 bg-gray-900/50 uppercase">
                                                <tr>
                                                    <th className="p-2">Time</th>
                                                    <th className="p-2">Side</th>
                                                    <th className="p-2">Team</th>
                                                    <th className="p-2 text-right">Price</th>
                                                    <th className="p-2 text-right">Qty</th>
                                                    <th className="p-2">Status</th>
                                                    <th className="p-2 text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {orders.filter(o => o.status === 'PENDING').length === 0 && (
                                                    <tr><td colSpan={7} className="p-4 text-center text-gray-600 italic">No active orders</td></tr>
                                                )}
                                                {orders.filter(o => o.status === 'PENDING').map(order => (
                                                    <tr key={order.id} className="border-b border-gray-700">
                                                        <td className="p-2 font-mono text-xs">{order.time}</td>
                                                        <td className={`p-2 font-bold ${order.side === 'BUY' ? 'text-red-500' : 'text-green-500'}`}>{order.side}</td>
                                                        <td className="p-2">{order.name} <span className="text-xs text-gray-500">({order.code})</span></td>
                                                        <td className="p-2 text-right font-mono">{order.type === 'MARKET' ? 'MKT' : order.price}</td>
                                                        <td className="p-2 text-right font-mono">{order.quantity}</td>
                                                        <td className="p-2"><span className="bg-yellow-500/20 text-yellow-500 px-2 py-0.5 rounded text-xs">{order.status}</span></td>
                                                        <td className="p-2 text-center">
                                                            <button 
                                                                onClick={() => cancelOrder(order.id)}
                                                                className="text-gray-400 hover:text-red-400 transition"
                                                            >
                                                                <XCircle size={16} />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>

                                        <h3 className="text-gray-400 text-xs font-bold mb-2 uppercase">Positions & Holdings</h3>
                                        <table className="w-full text-sm text-left text-gray-300 min-w-[600px]">
                                            <thead className="text-xs text-gray-500 bg-gray-900/50 uppercase">
                                                <tr>
                                                    <th className="p-2">Team</th>
                                                    <th className="p-2 text-right">Qty</th>
                                                    <th className="p-2 text-right">Avg Cost</th>
                                                    <th className="p-2 text-right">Cur Price</th>
                                                    <th className="p-2 text-right">Mkt Value</th>
                                                    <th className="p-2 text-right">Unrealized P/L</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {positions.length === 0 && (
                                                    <tr><td colSpan={6} className="p-4 text-center text-gray-600 italic">No positions held</td></tr>
                                                )}
                                                {positions.map(pos => (
                                                    <tr key={pos.code} className="border-b border-gray-700 hover:bg-gray-800/30">
                                                        <td className="p-2">
                                                            <span className="font-bold text-white">{pos.name}</span> <span className="text-xs text-gray-500">({pos.code})</span>
                                                        </td>
                                                        <td className="p-2 text-right font-mono">
                                                            {pos.quantity > 0 ? 
                                                                <span className="text-red-400">LONG {pos.quantity}</span> : 
                                                                <span className="text-green-400">SHORT {Math.abs(pos.quantity)}</span>
                                                            }
                                                        </td>
                                                        <td className="p-2 text-right font-mono text-gray-400">{pos.averageCost.toFixed(2)}</td>
                                                        <td className="p-2 text-right font-mono text-white">{pos.currentPrice.toFixed(2)}</td>
                                                        <td className="p-2 text-right font-mono text-white">{formatMoney(pos.marketValue)}</td>
                                                        <td className={`p-2 text-right font-mono font-bold ${getColorClass(pos.unrealizedPL)}`}>
                                                            {formatMoney(pos.unrealizedPL)} <span className="text-xs font-normal ml-1">({formatPercent(pos.unrealizedPLPercent)})</span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </main>

                    </div>

                    {/* FLOATING ANALYST BUTTON */}
                    <button 
                        onClick={() => setIsAnalystOpen(true)}
                        className="fixed bottom-6 right-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-full shadow-2xl border border-white/20 hover:scale-110 transition-transform z-40 group"
                    >
                        <Sparkles size={24} className="animate-bounce-slow" />
                        <span className="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                            Ask AI Analyst
                        </span>
                    </button>

                    {/* AI ANALYST MODAL */}
                    <AIAnalystModal 
                        isOpen={isAnalystOpen} 
                        onClose={() => setIsAnalystOpen(false)}
                        selectedStock={selectedStock}
                        allStocks={stocks}
                    />

                    {/* NOTIFICATION TOAST */}
                    {notification && (
                        <div className={`fixed top-4 right-4 px-6 py-3 rounded shadow-xl flex items-center z-50 animate-fade-in-down ${notification.type === 'success' ? 'bg-green-600 text-white' : notification.type === 'error' ? 'bg-red-600 text-white' : 'bg-blue-600 text-white'}`}>
                            {notification.type === 'success' ? <CheckCircle size={20} className="mr-2"/> : <AlertCircle size={20} className="mr-2"/>}
                            <span className="font-bold">{notification.msg}</span>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
