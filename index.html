<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Team Trader (US Rules & Tech Analysis)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* Animations */
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 overflow-hidden selection:bg-blue-500 selection:text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- API KEY (Optional for Gemini) ---
        const apiKey = ""; 

        // --- ICONS ---
        const IconBase = ({ children, className, size = 20 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const TrendingUp = (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></IconBase>;
        const TrendingDown = (p) => <IconBase {...p}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconBase>;
        const Activity = (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconBase>;
        const XCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17"></path><path d="M14 14.66V17"></path><path d="M12 2v20"></path><path d="M12 2a7 7 0 0 0-7 7c0 8.1 11.4 12 11.4 12S19 17.1 19 9a7 7 0 0 0-7-7z"></path></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></IconBase>;
        const LineChart = (p) => <IconBase {...p}><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></IconBase>;
        const Send = (p) => <IconBase {...p}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></IconBase>;

        // --- LOGIC HELPERS (US RULES) ---
        // US Market: Tick size is usually 0.01
        const getTickSize = (price) => 0.01;

        // US Colors: Green = Up, Red = Down
        const getColorClass = (val) => val > 0 ? 'text-green-500' : val < 0 ? 'text-red-500' : 'text-gray-400';
        const getBgColorClass = (val) => val > 0 ? 'bg-green-500/10 text-green-500' : val < 0 ? 'bg-red-500/10 text-red-500' : 'bg-gray-700 text-gray-300';
        const formatMoney = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        const formatPercent = (num) => `${num > 0 ? '+' : ''}${num.toFixed(2)}%`;

        // 30 MLB TEAMS (Mock Prices)
        const INITIAL_STOCKS_DATA = [
            { code: 'NYY', name: 'NY Yankees', refPrice: 158.20 },
            { code: 'LAD', name: 'LA Dodgers', refPrice: 185.50 },
            { code: 'BOS', name: 'Boston Red Sox', refPrice: 95.40 },
            { code: 'ATL', name: 'Atlanta Braves', refPrice: 120.10 },
            { code: 'HOU', name: 'Houston Astros', refPrice: 110.35 },
            { code: 'PHI', name: 'Phila Phillies', refPrice: 105.80 },
            { code: 'BAL', name: 'Baltimore Orioles', refPrice: 88.20 },
            { code: 'CHC', name: 'Chi Cubs', refPrice: 75.60 },
            { code: 'TOR', name: 'Toronto Blue Jays', refPrice: 65.40 },
            { code: 'NYM', name: 'NY Mets', refPrice: 92.15 },
            { code: 'SF', name: 'SF Giants', refPrice: 82.30 },
            { code: 'SD', name: 'SD Padres', refPrice: 98.50 },
            { code: 'TEX', name: 'Texas Rangers', refPrice: 78.90 },
            { code: 'SEA', name: 'Seattle Mariners', refPrice: 68.45 },
            { code: 'STL', name: 'St. Louis Cardinals', refPrice: 72.10 },
            { code: 'TB', name: 'Tampa Bay Rays', refPrice: 55.30 },
            { code: 'MIN', name: 'Minnesota Twins', refPrice: 48.90 },
            { code: 'CLE', name: 'Cleveland Guardians', refPrice: 52.40 },
            { code: 'MIL', name: 'Milwaukee Brewers', refPrice: 50.10 },
            { code: 'ARI', name: 'Arizona D-backs', refPrice: 58.60 },
            { code: 'MIA', name: 'Miami Marlins', refPrice: 25.30 },
            { code: 'CIN', name: 'Cincinnati Reds', refPrice: 32.15 },
            { code: 'DET', name: 'Detroit Tigers', refPrice: 28.90 },
            { code: 'PIT', name: 'Pittsburgh Pirates', refPrice: 22.40 },
            { code: 'WSH', name: 'Washington Nationals', refPrice: 35.60 },
            { code: 'LAA', name: 'LA Angels', refPrice: 45.20 },
            { code: 'KC', name: 'KC Royals', refPrice: 38.50 },
            { code: 'COL', name: 'Colorado Rockies', refPrice: 29.80 },
            { code: 'CWS', name: 'Chi White Sox', refPrice: 18.20 },
            { code: 'OAK', name: 'Oakland Athletics', refPrice: 15.10 },
        ];

        const INITIAL_STOCKS = INITIAL_STOCKS_DATA.map(s => ({
            ...s,
            price: s.refPrice,
            volume: Math.floor(Math.random() * 500000) + 100000,
            high: s.refPrice,
            low: s.refPrice,
            change: 0,
            changePercent: 0,
        }));

        // --- CHART COMPONENT ---
        const StockChart = ({ stockCode, history }) => {
            if (!history || history.length < 2) return (
                <div className="h-full flex items-center justify-center text-gray-500 text-sm flex-col">
                    <Activity size={48} className="mb-2 opacity-20" />
                    <span>Waiting for market data...</span>
                </div>
            );

            const data = history;
            const width = 600;
            const height = 300;
            const padding = 20;

            // Calculate scales
            const minPrice = Math.min(...data.map(d => d.price)) * 0.995; // minimal padding
            const maxPrice = Math.max(...data.map(d => d.price)) * 1.005;
            const priceRange = maxPrice - minPrice || 1;

            const getX = (index) => (index / (data.length - 1)) * (width - padding * 2) + padding;
            const getY = (price) => height - padding - ((price - minPrice) / priceRange) * (height - padding * 2);

            // Generate path for Line Chart
            const points = data.map((d, i) => `${getX(i)},${getY(d.price)}`).join(' ');
            
            // Generate Moving Average (Simple 5-period MA)
            let maPoints = "";
            if (data.length >= 5) {
                const maData = data.map((d, i, arr) => {
                    if (i < 4) return null;
                    const sum = arr.slice(i - 4, i + 1).reduce((acc, val) => acc + val.price, 0);
                    return sum / 5;
                });
                maPoints = maData.map((val, i) => val ? `${getX(i)},${getY(val)}` : null).filter(p => p).join(' ');
            }

            const startPrice = data[0].price;
            const endPrice = data[data.length - 1].price;
            const trendColor = endPrice >= startPrice ? "#22c55e" : "#ef4444"; // Green or Red

            return (
                <div className="w-full h-full relative select-none group">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                        {/* Grid Lines */}
                        <line x1={padding} y1={padding} x2={width-padding} y2={padding} stroke="#374151" strokeDasharray="4" opacity="0.3"/>
                        <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#374151" strokeDasharray="4" opacity="0.3"/>
                        <line x1={padding} y1={height/2} x2={width-padding} y2={height/2} stroke="#374151" strokeDasharray="4" opacity="0.1"/>

                        {/* Price Line */}
                        <polyline 
                            points={points} 
                            fill="none" 
                            stroke={trendColor} 
                            strokeWidth="2" 
                            strokeLinejoin="round"
                            className="drop-shadow-md"
                        />

                        {/* MA Line */}
                        {maPoints && (
                            <polyline 
                                points={maPoints} 
                                fill="none" 
                                stroke="#fbbf24" 
                                strokeWidth="1.5" 
                                strokeOpacity="0.7"
                                strokeDasharray="4"
                            />
                        )}

                        {/* Hover Effect (Last Point) */}
                        <circle cx={getX(data.length-1)} cy={getY(endPrice)} r="4" fill={trendColor} className="animate-pulse" />
                    </svg>
                    
                    {/* Current Price Badge */}
                    <div className="absolute top-2 right-2 bg-gray-800/80 px-2 py-1 rounded border border-gray-700 text-xs font-mono text-white">
                        Last: <span style={{color: trendColor}}>{endPrice.toFixed(2)}</span>
                    </div>
                    <div className="absolute top-8 right-2 flex items-center text-[10px] text-yellow-400">
                        <div className="w-3 h-0.5 bg-yellow-400 mr-1 border-dashed border-t border-yellow-400"></div> MA(5)
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [marketOpen, setMarketOpen] = useState(true);
            const [stocks, setStocks] = useState(INITIAL_STOCKS);
            const [selectedStockCode, setSelectedStockCode] = useState('NYY');
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('TRADE'); // 'TRADE' or 'CHART'
            
            // Historical Data for Charts: { Code: [{time, price}] }
            const [priceHistory, setPriceHistory] = useState({});

            const [account, setAccount] = useState({
                cash: 100000.00, // USD 100k
                totalAssets: 100000.00,
                realizedPL: 0,
            });
            const [positions, setPositions] = useState([]);
            const [orders, setOrders] = useState([]);
            
            // Order Form
            const [orderSide, setOrderSide] = useState('BUY');
            const [orderType, setOrderType] = useState('LIMIT');
            const [orderCondition, setOrderCondition] = useState('DAY'); // US Day Order
            const [orderPrice, setOrderPrice] = useState('');
            const [orderQty, setOrderQty] = useState('100'); // Default 100 shares
            const [notification, setNotification] = useState(null);
            
            // AI Modal
            const [isAnalystOpen, setIsAnalystOpen] = useState(false);

            // --- MARKET ENGINE ---
            useEffect(() => {
                // Initialize history
                const initialHistory = {};
                INITIAL_STOCKS.forEach(s => {
                    // Generate fake past 20 points
                    const hist = [];
                    let p = s.refPrice;
                    for(let i=0; i<20; i++) {
                        p = p * (1 + (Math.random() - 0.5) * 0.01);
                        hist.push({ time: Date.now() - (20-i)*2000, price: p });
                    }
                    initialHistory[s.code] = hist;
                });
                setPriceHistory(initialHistory);

                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                    
                    if (marketOpen) {
                        setStocks(prevStocks => {
                            const nextStocks = prevStocks.map(stock => {
                                if (Math.random() > 0.5) { 
                                    const direction = Math.random() > 0.5 ? 1 : -1;
                                    // US Volatility
                                    const movePercent = (Math.random() * 0.005) * direction; // 0.5% max move per tick
                                    let newPrice = stock.price * (1 + movePercent);
                                    newPrice = Math.round(newPrice * 100) / 100; // Round to penny
                                    
                                    const newHigh = Math.max(stock.high, newPrice);
                                    const newLow = Math.min(stock.low, newPrice);
                                    const newChange = newPrice - stock.refPrice;
                                    const newChangePercent = (newChange / stock.refPrice) * 100;
                                    const volAdd = Math.floor(Math.random() * 500); 

                                    return {
                                        ...stock,
                                        price: newPrice,
                                        high: newHigh,
                                        low: newLow,
                                        change: newChange,
                                        changePercent: newChangePercent,
                                        volume: stock.volume + volAdd
                                    };
                                }
                                return stock;
                            });

                            // Update History for ALL stocks (for chart data)
                            setPriceHistory(prevHist => {
                                const newHist = { ...prevHist };
                                nextStocks.forEach(s => {
                                    if(!newHist[s.code]) newHist[s.code] = [];
                                    newHist[s.code] = [...newHist[s.code], { time: Date.now(), price: s.price }].slice(-50); // Keep last 50 points
                                });
                                return newHist;
                            });

                            return nextStocks;
                        });
                    }
                }, 1000); // Fast tick for excitement

                return () => clearInterval(timer);
            }, [marketOpen]);

            // --- MATCHING ENGINE ---
            useEffect(() => {
                if (!marketOpen) return;
                setOrders(prevOrders => {
                    let hasUpdates = false;
                    const updatedOrders = prevOrders.map(order => {
                        if (order.status !== 'PENDING') return order;
                        const currentStock = stocks.find(s => s.code === order.code);
                        if (!currentStock) return order;

                        let isMatch = false;
                        if (order.side === 'BUY' && order.type === 'LIMIT' && currentStock.price <= order.price) isMatch = true;
                        if (order.side === 'SELL' && order.type === 'LIMIT' && currentStock.price >= order.price) isMatch = true;

                        if (isMatch) {
                            hasUpdates = true;
                            executeTrade(order, currentStock.price, order.quantity);
                            return { ...order, status: 'FILLED', filledQuantity: order.quantity, averageFillPrice: currentStock.price };
                        }
                        return order;
                    });
                    return hasUpdates ? updatedOrders : prevOrders;
                });
            }, [stocks, marketOpen]);

            // --- PORTFOLIO UPDATE ---
            useEffect(() => {
                setPositions(prev => prev.map(pos => {
                    const stock = stocks.find(s => s.code === pos.code);
                    if (!stock) return pos;
                    const marketValue = Math.abs(pos.quantity) * stock.price;
                    let unrealizedPL = 0;
                    if (pos.quantity > 0) unrealizedPL = (stock.price - pos.averageCost) * pos.quantity;
                    else unrealizedPL = (pos.averageCost - stock.price) * Math.abs(pos.quantity);
                    
                    const costBasis = Math.abs(pos.quantity) * pos.averageCost;
                    const unrealizedPLPercent = costBasis === 0 ? 0 : (unrealizedPL / costBasis) * 100;
                    return { ...pos, currentPrice: stock.price, marketValue, unrealizedPL, unrealizedPLPercent };
                }));
            }, [stocks]);

            useEffect(() => {
                const totalUnrealized = positions.reduce((acc, p) => acc + p.unrealizedPL, 0);
                // Net Liq = Cash + Realized + Unrealized (Simple model)
                setAccount(prev => ({ ...prev, totalAssets: 100000 + prev.realizedPL + totalUnrealized }));
            }, [positions, account.realizedPL]);

            const executeTrade = (order, fillPrice, fillQty) => {
                const tradeAmount = fillPrice * fillQty;
                const commission = Math.max(1, fillQty * 0.005); // US style commission, min $1
                
                setPositions(prev => {
                    const existing = prev.find(p => p.code === order.code);
                    if (!existing) {
                        const signedQty = order.side === 'BUY' ? fillQty : -fillQty;
                        return [...prev, {
                            code: order.code, name: order.name, quantity: signedQty, averageCost: fillPrice,
                            currentPrice: fillPrice, marketValue: tradeAmount, unrealizedPL: -commission, unrealizedPLPercent: 0
                        }];
                    } else {
                        // Simplify logic: Averaging
                        let newQty = existing.quantity + (order.side === 'BUY' ? fillQty : -fillQty);
                        if (Math.abs(newQty) < 0.001) return prev.filter(p => p.code !== order.code);
                        return prev.map(p => p.code === order.code ? { ...p, quantity: newQty } : p);
                    }
                });

                setAccount(prev => {
                    // Simply deduct commission and P/L realization would happen on close
                    // For this mock, just tracking cash flow roughly
                    let cashChange = order.side === 'BUY' ? -tradeAmount : tradeAmount;
                    return { ...prev, cash: prev.cash + cashChange - commission };
                });
                showNotification(`Filled ${order.side} ${fillQty} ${order.code} @ ${fillPrice}`, 'success');
            };

            const handleSubmitOrder = (e) => {
                e.preventDefault();
                const stock = stocks.find(s => s.code === selectedStockCode);
                if (!stock) return;
                const price = orderType === 'MARKET' ? stock.price : parseFloat(orderPrice);
                const qty = parseInt(orderQty);
                
                if (!qty || qty <= 0) return showNotification('Invalid Quantity', 'error');
                if (orderType === 'LIMIT' && (!price || price <= 0)) return showNotification('Invalid Price', 'error');

                const newOrder = {
                    id: Math.random().toString(36).substr(2, 9),
                    time: new Date().toLocaleTimeString(),
                    code: stock.code, name: stock.name, side: orderSide, type: orderType, condition: orderCondition,
                    price: price, quantity: qty, filledQuantity: 0, status: 'PENDING', averageFillPrice: 0
                };

                const canFill = orderType === 'MARKET' || (orderSide === 'BUY' ? stock.price <= price : stock.price >= price);

                if ((orderCondition === 'IOC' || orderCondition === 'FOK') && !canFill) {
                    showNotification(`${orderCondition} Order Cancelled`, 'info');
                } else if (canFill && orderType === 'MARKET') {
                    executeTrade(newOrder, stock.price, qty);
                } else {
                    setOrders(prev => [newOrder, ...prev]);
                    showNotification('Order Submitted', 'success');
                }
            };

            const showNotification = (msg, type) => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const selectedStock = stocks.find(s => s.code === selectedStockCode) || stocks[0];
            const currentPos = positions.find(p => p.code === selectedStockCode);
            const filteredStocks = stocks.filter(s => s.code.includes(searchTerm.toUpperCase()) || s.name.toLowerCase().includes(searchTerm.toLowerCase()));

            // --- AI ANALYST LOGIC (Placeholder) ---
            const AIAnalystModal = ({ isOpen, onClose }) => {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                        <div className="bg-gray-900 w-full max-w-md rounded-xl border border-gray-700 p-6 relative">
                            <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><XCircle/></button>
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-purple-400"><Sparkles/> AI Analyst</h2>
                            <div className="h-64 bg-gray-800 rounded p-4 overflow-y-auto text-sm text-gray-300 space-y-3">
                                <div className="bg-purple-900/20 p-3 rounded-lg border border-purple-500/30">
                                    <p className="font-bold text-purple-300 mb-1">Analysis for {selectedStock.code}:</p>
                                    <p>Based on current simulated volatility, {selectedStock.name} shows strong momentum. (This is a mock AI response for demo purposes).</p>
                                </div>
                            </div>
                            <div className="mt-4 flex gap-2">
                                <input type="text" placeholder="Ask a question..." className="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500"/>
                                <button className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded"><Send size={16}/></button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-screen bg-gray-950 text-gray-200 font-sans overflow-hidden">
                    {/* HEADER */}
                    <header className="h-14 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 shrink-0 z-20">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 p-1.5 rounded text-white"><Trophy size={18}/></div>
                            <h1 className="font-bold text-lg tracking-tight hidden sm:block">MLB Trader <span className="text-gray-500 font-normal text-xs">US Market</span></h1>
                        </div>
                        <div className="flex items-center gap-4 text-sm font-mono text-gray-400">
                            <div className={`flex items-center gap-1 ${marketOpen ? 'text-green-400' : 'text-red-400'}`}>
                                <div className={`w-2 h-2 rounded-full ${marketOpen ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`}></div>
                                {marketOpen ? 'MARKET OPEN' : 'CLOSED'}
                            </div>
                            <div className="hidden md:block">{currentTime.toLocaleTimeString()}</div>
                        </div>
                    </header>

                    {/* MAIN LAYOUT */}
                    <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                        
                        {/* LEFT SIDEBAR: MARKET LIST (Scrollable) */}
                        <aside className="w-full md:w-72 bg-gray-900 border-b md:border-b-0 md:border-r border-gray-800 flex flex-col shrink-0 h-1/3 md:h-full">
                            <div className="p-3 border-b border-gray-800">
                                <div className="relative">
                                    <Search className="absolute left-3 top-2.5 text-gray-500" size={14}/>
                                    <input 
                                        type="text" 
                                        placeholder="Symbol / Team" 
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full bg-gray-800 text-gray-200 pl-9 pr-3 py-2 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 placeholder-gray-600"
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {filteredStocks.map(stock => (
                                    <div 
                                        key={stock.code}
                                        onClick={() => setSelectedStockCode(stock.code)}
                                        className={`p-3 flex justify-between items-center cursor-pointer border-b border-gray-800/50 hover:bg-gray-800 transition-colors ${selectedStockCode === stock.code ? 'bg-blue-900/20 border-l-2 border-blue-500' : 'border-l-2 border-transparent'}`}
                                    >
                                        <div>
                                            <div className="font-bold text-sm text-white">{stock.code}</div>
                                            <div className="text-xs text-gray-500 truncate w-24">{stock.name}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-sm font-mono font-medium ${getColorClass(stock.change)}`}>{stock.price.toFixed(2)}</div>
                                            <div className={`text-xs ${getColorClass(stock.change)}`}>{formatPercent(stock.changePercent)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </aside>

                        {/* CENTER: WORKSPACE */}
                        <main className="flex-1 flex flex-col overflow-hidden bg-gray-950 relative">
                            
                            {/* STOCK HEADER */}
                            <div className="p-4 md:p-6 border-b border-gray-800 flex justify-between items-end bg-gray-900/50 shrink-0">
                                <div>
                                    <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                        {selectedStock.code} 
                                        <span className="text-base font-normal text-gray-500">{selectedStock.name}</span>
                                    </h2>
                                    <div className="flex items-baseline gap-3 mt-1">
                                        <span className={`text-4xl font-mono font-bold tracking-tighter ${getColorClass(selectedStock.change)}`}>
                                            {selectedStock.price.toFixed(2)}
                                        </span>
                                        <span className={`flex items-center text-lg font-medium ${getColorClass(selectedStock.change)}`}>
                                            {selectedStock.change > 0 ? <TrendingUp size={20} className="mr-1"/> : <TrendingDown size={20} className="mr-1"/>}
                                            {selectedStock.change > 0 ? '+' : ''}{selectedStock.change.toFixed(2)} ({formatPercent(selectedStock.changePercent)})
                                        </span>
                                    </div>
                                </div>
                                <div className="hidden sm:block text-right text-sm text-gray-400 font-mono">
                                    <div>VOL: <span className="text-gray-200">{selectedStock.volume.toLocaleString()}</span></div>
                                    <div>HIGH: <span className="text-gray-200">{selectedStock.high.toFixed(2)}</span></div>
                                    <div>LOW: <span className="text-gray-200">{selectedStock.low.toFixed(2)}</span></div>
                                </div>
                            </div>

                            {/* TAB NAVIGATION */}
                            <div className="flex border-b border-gray-800 bg-gray-900/30 shrink-0">
                                <button 
                                    onClick={() => setActiveTab('TRADE')}
                                    className={`px-6 py-3 text-sm font-bold transition-colors ${activeTab === 'TRADE' ? 'text-blue-400 border-b-2 border-blue-400 bg-blue-500/5' : 'text-gray-500 hover:text-gray-300'}`}
                                >
                                    Trading
                                </button>
                                <button 
                                    onClick={() => setActiveTab('CHART')}
                                    className={`px-6 py-3 text-sm font-bold transition-colors flex items-center gap-2 ${activeTab === 'CHART' ? 'text-purple-400 border-b-2 border-purple-400 bg-purple-500/5' : 'text-gray-500 hover:text-gray-300'}`}
                                >
                                    <LineChart size={16}/> Technical Analysis
                                </button>
                            </div>

                            {/* SCROLLABLE CONTENT AREA */}
                            <div className="flex-1 overflow-y-auto p-4 md:p-6">
                                
                                {/* TRADE TAB CONTENT */}
                                {activeTab === 'TRADE' && (
                                    <div className="flex flex-col lg:flex-row gap-6 max-w-6xl mx-auto">
                                        {/* ORDER ENTRY FORM */}
                                        <div className="w-full lg:w-1/2 bg-gray-900 rounded-xl border border-gray-800 p-5 shadow-lg h-fit">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="font-bold text-gray-200 flex items-center gap-2"><Activity size={18}/> Order Entry</h3>
                                                <div className="text-xs bg-gray-800 px-2 py-1 rounded border border-gray-700">
                                                    {currentPos ? (
                                                        <span className={currentPos.quantity > 0 ? "text-green-400" : "text-red-400"}>
                                                            POS: {currentPos.quantity > 0 ? "+" : ""}{currentPos.quantity}
                                                        </span>
                                                    ) : <span className="text-gray-500">POS: 0</span>}
                                                </div>
                                            </div>

                                            <form onSubmit={handleSubmitOrder} className="space-y-4">
                                                <div className="flex bg-gray-800 p-1 rounded-lg">
                                                    <button type="button" onClick={() => setOrderSide('BUY')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${orderSide === 'BUY' ? 'bg-green-600 text-white shadow' : 'text-gray-400 hover:text-gray-200'}`}>Buy</button>
                                                    <button type="button" onClick={() => setOrderSide('SELL')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${orderSide === 'SELL' ? 'bg-red-600 text-white shadow' : 'text-gray-400 hover:text-gray-200'}`}>Sell / Short</button>
                                                </div>

                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-xs text-gray-500 block mb-1">Order Type</label>
                                                        <select value={orderType} onChange={e => setOrderType(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none text-white">
                                                            <option value="LIMIT">Limit</option>
                                                            <option value="MARKET">Market</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-500 block mb-1">Time in Force</label>
                                                        <select value={orderCondition} onChange={e => setOrderCondition(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none text-white">
                                                            <option value="DAY">Day</option>
                                                            <option value="IOC">IOC</option>
                                                            <option value="FOK">FOK</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-xs text-gray-500 block mb-1">Shares</label>
                                                        <input type="number" min="1" value={orderQty} onChange={e => setOrderQty(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none font-mono text-right text-white" />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-500 block mb-1">Price ($)</label>
                                                        <input type="number" step="0.01" disabled={orderType === 'MARKET'} value={orderType === 'MARKET' ? '' : orderPrice} onChange={e => setOrderPrice(e.target.value)} placeholder={orderType === 'MARKET' ? 'MKT' : selectedStock.price.toFixed(2)} className={`w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none font-mono text-right text-white ${orderType === 'MARKET' ? 'opacity-50 cursor-not-allowed' : ''}`} />
                                                    </div>
                                                </div>

                                                <div className="pt-2">
                                                    <button type="submit" className={`w-full py-3 rounded-lg font-bold text-white shadow-lg transform transition active:scale-95 ${orderSide === 'BUY' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'}`}>
                                                        {orderSide === 'BUY' ? 'SUBMIT BUY ORDER' : 'SUBMIT SELL ORDER'}
                                                    </button>
                                                </div>
                                                
                                                <div className="text-center text-xs text-gray-500">
                                                    Est. Total: <span className="text-gray-300 font-mono">{formatMoney((parseFloat(orderPrice) || selectedStock.price) * parseInt(orderQty))}</span>
                                                </div>
                                            </form>
                                        </div>

                                        {/* ORDER BOOK / DEPTH */}
                                        <div className="w-full lg:w-1/2 bg-gray-900 rounded-xl border border-gray-800 p-5 shadow-lg h-fit">
                                            <h3 className="font-bold text-gray-200 mb-3 text-sm">Level 2 Data (Simulated)</h3>
                                            <div className="grid grid-cols-2 gap-2 text-xs font-mono mb-2 text-gray-500 uppercase">
                                                <div>Bid Size @ Price</div>
                                                <div className="text-right">Price @ Ask Size</div>
                                            </div>
                                            <div className="space-y-0.5">
                                                {/* Asks (Red) - Sellers - Top Down */}
                                                {[4,3,2,1,0].map(i => {
                                                    const p = selectedStock.price + (i+1)*0.05;
                                                    const size = Math.floor(Math.random() * 500) + 100;
                                                    return (
                                                        <div key={`ask-${i}`} className="flex justify-between items-center bg-red-900/10 hover:bg-red-900/20 cursor-pointer py-1 px-2 rounded" onClick={() => setOrderPrice(p.toFixed(2))}>
                                                            <span></span>
                                                            <div className="text-red-400 flex gap-4">
                                                                <span>{p.toFixed(2)}</span>
                                                                <span className="text-gray-400 w-8 text-right">{size}</span>
                                                            </div>
                                                        </div>
                                                    )
                                                })}
                                                
                                                {/* Spread / Current */}
                                                <div className="py-2 flex justify-center items-center border-y border-gray-700 my-1">
                                                    <span className="text-lg font-bold text-white">{selectedStock.price.toFixed(2)}</span>
                                                </div>

                                                {/* Bids (Green) - Buyers - Top Down */}
                                                {[0,1,2,3,4].map(i => {
                                                    const p = selectedStock.price - (i+1)*0.05;
                                                    const size = Math.floor(Math.random() * 500) + 100;
                                                    return (
                                                        <div key={`bid-${i}`} className="flex justify-between items-center bg-green-900/10 hover:bg-green-900/20 cursor-pointer py-1 px-2 rounded" onClick={() => setOrderPrice(p.toFixed(2))}>
                                                            <div className="text-green-400 flex gap-4">
                                                                <span className="text-gray-400 w-8">{size}</span>
                                                                <span>{p.toFixed(2)}</span>
                                                            </div>
                                                            <span></span>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* CHART TAB CONTENT */}
                                {activeTab === 'CHART' && (
                                    <div className="w-full h-[400px] md:h-[500px] bg-gray-900 border border-gray-800 rounded-xl p-4 shadow-lg">
                                        <div className="h-full w-full">
                                            <StockChart 
                                                stockCode={selectedStockCode}
                                                history={priceHistory[selectedStockCode]}
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* POSITIONS & ORDERS LIST (Always Visible below) */}
                                <div className="mt-8">
                                    <h3 className="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Positions & Active Orders</h3>
                                    <div className="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-xs text-gray-500 bg-gray-950 uppercase border-b border-gray-800">
                                                    <tr>
                                                        <th className="px-4 py-3">Symbol</th>
                                                        <th className="px-4 py-3 text-right">Qty</th>
                                                        <th className="px-4 py-3 text-right">Avg Price</th>
                                                        <th className="px-4 py-3 text-right">Last</th>
                                                        <th className="px-4 py-3 text-right">Mkt Val</th>
                                                        <th className="px-4 py-3 text-right">P/L Open</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-800">
                                                    {positions.length === 0 && <tr><td colSpan="6" className="p-4 text-center text-gray-600 italic">No open positions</td></tr>}
                                                    {positions.map(pos => (
                                                        <tr key={pos.code} className="hover:bg-gray-800/50 transition-colors">
                                                            <td className="px-4 py-3 font-bold text-white">{pos.code}</td>
                                                            <td className={`px-4 py-3 text-right font-mono ${pos.quantity > 0 ? 'text-blue-400' : 'text-purple-400'}`}>
                                                                {pos.quantity}
                                                            </td>
                                                            <td className="px-4 py-3 text-right font-mono text-gray-400">{pos.averageCost.toFixed(2)}</td>
                                                            <td className="px-4 py-3 text-right font-mono text-white">{pos.currentPrice.toFixed(2)}</td>
                                                            <td className="px-4 py-3 text-right font-mono text-gray-300">{formatMoney(pos.marketValue)}</td>
                                                            <td className={`px-4 py-3 text-right font-mono font-bold ${getColorClass(pos.unrealizedPL)}`}>
                                                                {formatMoney(pos.unrealizedPL)} <span className="text-xs opacity-70 ml-1">({formatPercent(pos.unrealizedPLPercent)})</span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            {/* FOOTER STATUS BAR */}
                            <div className="h-10 bg-gray-900 border-t border-gray-800 flex items-center justify-between px-4 text-xs text-gray-400 shrink-0">
                                <div className="flex gap-4">
                                    <span>Cash: <span className="text-white font-mono">{formatMoney(account.cash)}</span></span>
                                    <span>Eq: <span className="text-white font-mono">{formatMoney(account.totalAssets)}</span></span>
                                </div>
                                <div className="flex gap-2 items-center">
                                    <div className={`w-1.5 h-1.5 rounded-full ${apiKey ? 'bg-green-500' : 'bg-gray-500'}`}></div>
                                    <span>API: {apiKey ? 'Connected' : 'Demo Mode'}</span>
                                </div>
                            </div>

                        </main>
                    </div>

                    {/* FLOATING ANALYST BUTTON */}
                    <button 
                        onClick={() => setIsAnalystOpen(true)}
                        className="fixed bottom-16 md:bottom-8 right-4 md:right-8 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-full shadow-2xl shadow-purple-900/50 hover:scale-110 transition-transform z-50 group"
                    >
                        <Sparkles size={24} className="animate-pulse-slow" />
                    </button>

                    {/* AI MODAL */}
                    <AIAnalystModal isOpen={isAnalystOpen} onClose={() => setIsAnalystOpen(false)} />

                    {/* TOAST NOTIFICATION */}
                    {notification && (
                        <div className={`fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 z-50 fade-in border border-white/10 ${notification.type === 'success' ? 'bg-green-900/90 text-green-100' : notification.type === 'error' ? 'bg-red-900/90 text-red-100' : 'bg-blue-900/90 text-blue-100'}`}>
                            {notification.type === 'success' ? <CheckCircle size={20}/> : <AlertCircle size={20}/>}
                            <span className="font-medium">{notification.msg}</span>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
