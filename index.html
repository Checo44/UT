<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTrader: Enhanced Layout Swap (MLB)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Professional Dark Theme tweaks */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Roboto Mono", "Segoe UI", Helvetica, Arial, sans-serif; 
            background-color: #0b0e11; /* Deep Brokerage Black */
        }
        .font-mono-num { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Scrollbar - Slim & Dark */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* Ensure canvas is flexible */
        .chart-container canvas {
            display: block;
        }

        /* Table Cell Styling for volume bars */
        /* IMPORTANT: Setting TD to relative and background div to absolute inside ensures the bar is behind the content */
        .market-depth-table td {
            padding: 0; /* Remove default padding for full background coverage */
            height: 30px; /* Fixed height for rows */
        }
        .market-depth-table .relative-cell {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body class="text-gray-300 overflow-hidden selection:bg-blue-500/30 selection:text-blue-200">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (Lucide) ---
        const Icon = ({ d, size=16, className, children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {d && <path d={d}/>}
                {children}
            </svg>
        );

        const Icons = {
            Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Briefcase: (p) => <Icon {...p} d="M20 7h-3a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>,
            X: (p) => <Icon {...p} d="M18 6L6 18 M6 6l12 12"/>,
            Settings: (p) => (
                <Icon {...p} d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V4a2 2 0 0 0-2-2z">
                    <circle cx="12" cy="12" r="3"/>
                </Icon>
            ),
            Wifi: (p) => <Icon {...p} d="M5 12.55a11 11 0 0 1 14.08 0 M1.42 9a16 16 0 0 1 21.16 0 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01"/>,
        };

        // --- CONSTANTS & HELPERS ---
        const INITIAL_CASH = 100000.00;
        const STATIC_PRICE = 100.00; // 價格固定為 100.00
        
        // MLB 30 隊數據
        const INITIAL_DATA = [
            { c:'ARI', n:'Arizona Diamondbacks (亞利桑那響尾蛇)', p:STATIC_PRICE },
            { c:'ATL', n:'Atlanta Braves (亞特蘭大勇士)', p:STATIC_PRICE },
            { c:'BAL', n:'Baltimore Orioles (巴爾的摩金鶯)', p:STATIC_PRICE },
            { c:'BOS', n:'Boston Red Sox (波士頓紅襪)', p:STATIC_PRICE },
            { c:'CHC', n:'Chicago Cubs (芝加哥小熊)', p:STATIC_PRICE },
            { c:'CHW', n:'Chicago White Sox (芝加哥白襪)', p:STATIC_PRICE },
            { c:'CIN', n:'Cincinnati Reds (辛辛那提紅人)', p:STATIC_PRICE },
            { c:'CLE', n:'Cleveland Guardians (克里夫蘭守護者)', p:STATIC_PRICE },
            { c:'COL', n:'Colorado Rockies (科羅拉多洛磯)', p:STATIC_PRICE },
            { c:'DET', n:'Detroit Tigers (底特律老虎)', p:STATIC_PRICE },
            { c:'HOU', n:'Houston Astros (休士頓太空人)', p:STATIC_PRICE },
            { c:'KCR', n:'Kansas City Royals (堪薩斯市皇家)', p:STATIC_PRICE },
            { c:'LAA', n:'Los Angeles Angels (洛杉磯天使)', p:STATIC_PRICE },
            { c:'LAD', n:'Los Angeles Dodgers (洛杉磯道奇)', p:STATIC_PRICE },
            { c:'MIA', n:'Miami Marlins (邁阿密馬林魚)', p:STATIC_PRICE },
            { c:'MIL', n:'Milwaukee Brewers (密爾瓦基釀酒人)', p:STATIC_PRICE },
            { c:'MIN', n:'Minnesota Twins (明尼蘇達雙城)', p:STATIC_PRICE },
            { c:'NYM', n:'New York Mets (紐約大都會)', p:STATIC_PRICE },
            { c:'NYY', n:'New York Yankees (紐約洋基)', p:STATIC_PRICE },
            { c:'OAK', n:'Oakland Athletics (奧克蘭運動家)', p:STATIC_PRICE },
            { c:'PHI', n:'Philadelphia Phillies (費城費城人)', p:STATIC_PRICE },
            { c:'PIT', n:'Pittsburgh Pirates (匹茲堡海盜)', p:STATIC_PRICE },
            { c:'SDP', n:'San Diego Padres (聖地牙哥教士)', p:STATIC_PRICE },
            { c:'SEA', n:'Seattle Mariners (西雅圖水手)', p:STATIC_PRICE },
            { c:'SFG', n:'San Francisco Giants (舊金山巨人)', p:STATIC_PRICE },
            { c:'STL', n:'St. Louis Cardinals (聖路易紅雀)', p:STATIC_PRICE },
            { c:'TBR', n:'Tampa Bay Rays (坦帕灣光芒)', p:STATIC_PRICE },
            { c:'TEX', n:'Texas Rangers (德州遊騎兵)', p:STATIC_PRICE },
            { c:'TOR', n:'Toronto Blue Jays (多倫多藍鳥)', p:STATIC_PRICE },
            { c:'WAS', n:'Washington Nationals (華盛頓國民)', p:STATIC_PRICE },
        ];


        const fmtUSD = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(n);
        const col = (n) => n > 0 ? 'text-green-500' : n < 0 ? 'text-red-500' : 'text-gray-400';
        
        // --- COMPONENTS ---

        // K 線圖繪製 - 顯示靜態價格線
        const KLineChart = ({ price }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                const parent = canvas.parentElement;
                let width = parent.clientWidth;
                let height = parent.clientHeight;
                
                // Set canvas dimensions to parent container size
                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, width, height);

                // Draw background
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, width, height);

                // Draw horizontal line for $100.00 (mid-point for simplicity)
                const yCenter = height * 0.5;
                ctx.strokeStyle = '#3b82f6'; // Blue for the static price line
                ctx.lineWidth = 1.5;
                ctx.setLineDash([5, 5]); // Dashed line
                ctx.beginPath();
                ctx.moveTo(0, yCenter);
                ctx.lineTo(width, yCenter);
                ctx.stroke();

                // Draw price label
                ctx.setLineDash([]); // Solid line for text background
                ctx.font = '10px Roboto Mono';
                
                // Draw a small black box behind the price label for contrast
                ctx.fillStyle = '#111827';
                ctx.fillRect(width - 50, yCenter - 8, 50, 16); 
                
                ctx.fillStyle = '#3b82f6';
                ctx.textAlign = 'right';
                ctx.fillText(`$${price.toFixed(2)}`, width - 5, yCenter + 4);

                // Draw description text
                ctx.fillStyle = '#9ca3af';
                ctx.textAlign = 'center';
                ctx.font = '12px sans-serif';
                ctx.fillText('價格靜態 $100.00: 等待數據變動後開始繪製 K 線圖', width / 2, height / 2);

            }, [price]); // Redraw when price changes (though it is static)

            return (
                <div className="w-full h-full chart-container min-h-[180px] flex items-center justify-center">
                    <canvas ref={canvasRef} className="w-full h-full" />
                </div>
            );
        };


        // Market Depth / 各隊委託狀態區 (New Component)
        const MarketDepth = ({ price }) => {
            // Static depth levels based around the price 100.00
            const mockLevels = useMemo(() => {
                const levels = [];
                const baseVolume = 1500;
                
                // 5 Bid levels (委買價 - Green/Inner Market)
                for (let i = 0; i < 5; i++) {
                    levels.push({
                        price: price - 0.05 * (4 - i), // e.g., 99.80, 99.85, 99.90, 99.95, 100.00 (Note: price is 100.00 so highest bid is 99.95)
                        qty: baseVolume + (i * 200) + (i % 2 === 0 ? 50 : -50),
                        side: 'BID'
                    });
                }
                // 5 Ask levels (委賣價 - Red/Outer Market)
                for (let i = 0; i < 5; i++) {
                    levels.push({
                        price: price + 0.05 * (i + 1), // e.g., 100.05, 100.10, 100.15, 100.20, 100.25
                        qty: baseVolume + (i * 150) + (i % 3 === 0 ? 100 : 0),
                        side: 'ASK'
                    });
                }

                // Sort and pair for 5 symmetrical rows
                const bids = levels.filter(l => l.side === 'BID').sort((a, b) => b.price - a.price); // Highest bid first
                const asks = levels.filter(l => l.side === 'ASK').sort((a, b) => a.price - b.price); // Lowest ask first

                // Align bids and asks for 5 rows
                const rows = bids.map((bid, index) => ({
                    bid: bid,
                    ask: asks[index]
                }));

                const allQtys = levels.map(l => l.qty);
                const maxQty = Math.max(...allQtys);
                const totalBidQty = bids.reduce((sum, b) => sum + b.qty, 0);
                const totalAskQty = asks.reduce((sum, a) => sum + a.qty, 0);

                return { rows, maxQty, totalBidQty, totalAskQty };
            }, [price]);

            const { rows, maxQty, totalBidQty, totalAskQty } = mockLevels;
            const totalVol = totalBidQty + totalAskQty;
            const bidPct = totalVol > 0 ? (totalBidQty / totalVol) * 100 : 50;
            const askPct = totalVol > 0 ? (totalAskQty / totalVol) * 100 : 50;


            return (
                <div className="flex flex-col p-2 bg-gray-950/50 flex-1 overflow-y-auto">
                    {/* Inner/Outer Market Header (內盤/外盤) */}
                    <div className="flex flex-col mb-3 border-b border-gray-800 pb-2">
                        <div className="flex justify-center text-xs font-bold font-sans">
                            <span className="text-green-500 mr-2">
                                內盤 <span className='font-mono-num'>{totalBidQty.toLocaleString()}</span>
                                <span className="text-gray-400">({bidPct.toFixed(2)}%)</span>
                            </span>
                            <span className="text-red-500 ml-2">
                                外盤 <span className='font-mono-num'>{totalAskQty.toLocaleString()}</span>
                                <span className="text-gray-400">({askPct.toFixed(2)}%)</span>
                            </span>
                        </div>
                        {/* Percentage Bar */}
                        <div className="flex w-full h-2 mt-1 rounded overflow-hidden">
                            <div className="bg-green-600 transition-all duration-300" style={{ width: `${bidPct}%` }}></div>
                            <div className="bg-red-600 transition-all duration-300" style={{ width: `${askPct}%` }}></div>
                        </div>
                    </div>
                    
                    {/* Order Book Table */}
                    <div className="flex-1 min-h-0 overflow-hidden">
                        <table className="w-full text-left text-[11px] border-collapse relative market-depth-table">
                            <thead className="text-gray-500 sticky top-0 bg-gray-950/70 border-b border-gray-700">
                                <tr>
                                    <th className="text-right px-2 py-1">量</th>
                                    <th className="text-right px-2 py-1">委買價</th>
                                    <th className="text-left px-2 py-1">委賣價</th>
                                    <th className="text-left px-2 py-1">量</th>
                                </tr>
                            </thead>
                            <tbody className="font-mono-num divide-y divide-gray-900/50">
                                {rows.map((r, index) => {
                                    const bidWidthPct = (r.bid.qty / maxQty) * 100;
                                    const askWidthPct = (r.ask.qty / maxQty) * 100;
                                    
                                    return (
                                        <tr key={r.bid.price} className="h-[30px] transition-colors text-xs font-mono-num">
                                            
                                            {/* QTY (Bid) - Volume Bar is inside this cell, right aligned */}
                                            <td className="relative w-1/4">
                                                {/* Bid Bar Background (Right aligned, Green) */}
                                                <div 
                                                    className="absolute top-0 right-0 h-full bg-green-900/40 transition-all duration-300" 
                                                    style={{ width: `${bidWidthPct}%` }}
                                                />
                                                <div className="relative-cell justify-end pr-2 text-green-300">
                                                    <span className='z-10 relative'>{r.bid.qty.toLocaleString()}</span>
                                                </div>
                                            </td>
                                            
                                            {/* BID PRICE (委買價) */}
                                            <td className="relative w-1/4">
                                                <div className="relative-cell justify-end pr-2 text-green-400 font-bold">
                                                    <span className='z-10 relative'>{r.bid.price.toFixed(2)}</span>
                                                </div>
                                            </td>
                                            
                                            {/* ASK PRICE (委賣價) - Volume Bar is inside this cell, left aligned */}
                                            <td className="relative w-1/4">
                                                {/* Ask Bar Background (Left aligned, Red) */}
                                                <div 
                                                    className="absolute top-0 left-0 h-full bg-red-900/40 transition-all duration-300" 
                                                    style={{ width: `${askWidthPct}%` }}
                                                />
                                                <div className="relative-cell justify-start pl-2 text-red-400 font-bold">
                                                    <span className='z-10 relative'>{r.ask.price.toFixed(2)}</span>
                                                </div>
                                            </td>
                                            
                                            {/* QTY (Ask) */}
                                            <td className="relative w-1/4">
                                                <div className="relative-cell justify-start pl-2 text-red-300">
                                                    <span className='z-10 relative'>{r.ask.qty.toLocaleString()}</span>
                                                </div>
                                            </td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                            <tfoot className="sticky bottom-0 bg-gray-950/90 border-t border-gray-700 font-bold text-gray-500 text-xs">
                                <tr>
                                    <td colSpan="2" className="text-center">
                                        <div className="flex justify-between items-center py-1 border-r border-gray-700">
                                            <span className="pl-2">小計</span>
                                            <span className="font-mono-num pr-2 text-green-400">{totalBidQty.toLocaleString()}</span>
                                        </div>
                                    </td>
                                    <td colSpan="2" className="text-center">
                                        <div className="flex justify-between items-center py-1">
                                            <span className="pl-2 font-mono-num text-red-400">{totalAskQty.toLocaleString()}</span>
                                            <span className="pr-2">小計</span>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        };
        
        // Order Entry Form
        const OrderEntryForm = ({ order, selCode, account, setOrder, placeOrder, notify, setQtyByPct }) => {
            const tradePrice = order.type === 'MARKET' ? STATIC_PRICE : parseFloat(order.price) || STATIC_PRICE;
            const tradeQty = parseInt(order.qty) || 0;
            const estimatedValue = tradePrice * tradeQty;

            return (
                <form onSubmit={placeOrder} className="p-4 border-b border-gray-800">
                    <h3 className="text-white font-bold text-md mb-3 text-center border-b border-gray-700/50 pb-2">下單板: {selCode}</h3>
                    
                    {/* Buy/Sell Toggles */}
                    <div className="flex gap-2 mb-3">
                        <button type="button" onClick={() => setOrder(p => ({ ...p, side: 'BUY' }))} className={`flex-1 py-2 rounded-md font-bold text-sm transition-colors ${order.side === 'BUY' ? 'bg-green-600 text-white shadow-md shadow-green-900/50' : 'bg-gray-700 text-gray-300 hover:bg-green-700/50'}`}>
                            買入 (BUY)
                        </button>
                        <button type="button" onClick={() => setOrder(p => ({ ...p, side: 'SELL' }))} className={`flex-1 py-2 rounded-md font-bold text-sm transition-colors ${order.side === 'SELL' ? 'bg-red-600 text-white shadow-md shadow-red-900/50' : 'bg-gray-700 text-gray-300 hover:bg-red-700/50'}`}>
                            賣出 (SELL)
                        </button>
                    </div>

                    {/* Order Type & TIF */}
                    <div className="flex gap-2 mb-3">
                        <select value={order.type} onChange={e => setOrder(p => ({ ...p, type: e.target.value }))} className="flex-1 bg-gray-800 border border-gray-700 rounded p-1 text-gray-300 outline-none text-xs">
                            <option value="LIMIT">限價</option>
                            <option value="MARKET">市價</option>
                        </select>
                        <select value={order.tif} onChange={e => setOrder(p => ({ ...p, tif: e.target.value }))} className="w-1/3 bg-gray-800 border border-gray-700 rounded p-1 text-gray-300 outline-none text-xs">
                            <option value="DAY">當日</option>
                            <option value="IOC">IOC</option>
                            <option value="FOK">FOK</option>
                        </select>
                    </div>

                    {/* Quantity Input */}
                    <label className="block text-gray-500 mb-1 text-xs">數量 (QTY)</label>
                    <input type="number" min="1" step="1" value={order.qty} onChange={e => setOrder(p => ({ ...p, qty: e.target.value }))} placeholder="數量" className="w-full bg-gray-800 border border-gray-700 rounded p-1.5 text-white font-mono-num outline-none focus:border-blue-500 mb-2 text-xs"/>
                    <div className="flex gap-1 mb-3">
                        {[0.1, 0.25, 0.5, 1].map(pct => (
                            <button key={pct} type="button" onClick={() => setQtyByPct(pct)} className="flex-1 bg-gray-700 text-gray-400 hover:bg-gray-600/50 rounded py-0.5 text-[9px]">
                                {pct*100}% 現金
                            </button>
                        ))}
                    </div>

                    {/* Price Input (Conditional) */}
                    {order.type === 'LIMIT' && (
                        <>
                            <label className="block text-gray-500 mb-1 text-xs">價格 (PRICE)</label>
                            <input type="number" step="0.01" value={order.price} onChange={e => setOrder(p => ({ ...p, price: e.target.value }))} placeholder={STATIC_PRICE.toFixed(2)} className="w-full bg-gray-800 border border-gray-700 rounded p-1.5 text-white font-mono-num outline-none focus:border-blue-500 mb-3 text-xs"/>
                        </>
                    )}

                    {/* Estimated Value */}
                    <div className="flex justify-between text-sm mb-3 border-t border-gray-800 pt-3">
                        <span className="text-gray-500">預計價值:</span>
                        <span className="text-yellow-400 font-mono-num font-bold">{fmtUSD(estimatedValue)}</span>
                    </div>

                    {/* Submit Button */}
                    <button type="submit" className={`w-full py-2 rounded-md font-bold transition-all text-sm ${order.side === 'BUY' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'} text-white shadow-xl shadow-gray-900/50`}>
                        提交 {order.side} 訂單
                    </button>
                </form>
            );
        }

        // --- MAIN APP ---
        function App() {
            // State initialization... (same as before)
            const [time, setTime] = useState(new Date());
            const [stocks, setStocks] = useState(INITIAL_DATA.map(s => ({ 
                ...s, 
                price: STATIC_PRICE, 
                refPrice: STATIC_PRICE, 
                high: STATIC_PRICE, 
                low: STATIC_PRICE, 
                open: STATIC_PRICE, 
                vol: 0, 
                change: 0, 
                pct: 0 
            })));
            const [selCode, setSelCode] = useState('ARI'); 
            
            // Account State 
            const [account, setAccount] = useState({ 
                cash: INITIAL_CASH, 
                realized: 0, 
                uplTotal: 0, 
                netLiq: INITIAL_CASH,
                dayPL: 0
            });
            const [pos, setPos] = useState([]);
            const [orders, setOrders] = useState([]);
            
            // Order Entry State
            const [order, setOrder] = useState({ side: 'BUY', type: 'LIMIT', tif: 'DAY', qty: '', price: '' });
            const [msg, setMsg] = useState(null);
            
            // New State for Filtering
            const [searchQuery, setSearchQuery] = useState('');

            // Time update for header only
            useEffect(() => {
                const interval = setInterval(() => {
                    setTime(new Date());
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // --- P/L ENGINE (Runs on Cash/Position change) ---
            useEffect(() => {
                let uplTotal = 0;

                setPos(prev => prev.map(p => {
                    // Current mark price is always STATIC_PRICE (無價格變動)
                    const markPrice = STATIC_PRICE; 
                    const absQty = Math.abs(p.qty);
                    // P/L is based on avg cost vs static mark price.
                    const upl = p.qty > 0 ? (markPrice - p.avg) * p.qty : (p.avg - markPrice) * absQty;
                    uplTotal += upl;

                    // uplPct calculation is retained for completeness
                    const uplPct = absQty > 0 ? (upl / (p.avg * absQty)) * 100 : 0;

                    return { ...p, mark: markPrice, mktVal: absQty * markPrice, upl, uplPct };
                }));

                setAccount(a => {
                    const newNetLiq = a.cash + uplTotal; 
                    const dayPL = newNetLiq - INITIAL_CASH; 
                    return { ...a, uplTotal, netLiq: newNetLiq, dayPL };
                });

            }, [account.cash]); 

            // --- ACTIONS ---
            const executeTrade = (ord, price) => {
                const tradeQty = parseInt(ord.qty);
                const tradeAmt = price * tradeQty;
                // Mock commission: 0.5% of value, minimum 1.00
                const comm = Math.max(1.00, tradeAmt * 0.005); 
                const isBuy = ord.side === 'BUY';
                const transactionCostOrProceeds = isBuy ? -tradeAmt - comm : tradeAmt - comm;
                let realizedPL = 0;

                setPos(prev => {
                    const exIndex = prev.findIndex(p => p.code === ord.code);
                    let nextPos = [...prev];
                    
                    if (exIndex !== -1) {
                        const ex = nextPos[exIndex];
                        const exQty = ex.qty;
                        const isClosing = (isBuy && exQty < 0) || (!isBuy && exQty > 0);

                        if (isClosing) {
                            const closeQty = Math.min(tradeQty, Math.abs(exQty));
                            
                            if (exQty > 0) { // Closing Long with SELL
                                realizedPL = (price - ex.avg) * closeQty;
                            } else { // Closing Short with BUY
                                realizedPL = (ex.avg - price) * closeQty;
                            }

                            const remainingQty = exQty + (isBuy ? closeQty : -closeQty);

                            if (Math.abs(remainingQty) < 1) {
                                nextPos = prev.filter((p, i) => i !== exIndex);
                            } else {
                                // Reversal: calculate new average based on remaining and new shares
                                const netValue = (ex.avg * Math.abs(exQty)) + (price * (isBuy ? tradeQty : -tradeQty));
                                const netShares = remainingQty;
                                const newAvg = netValue / Math.abs(netShares);
                                nextPos = prev.filter((p, i) => i !== exIndex);
                                nextPos.push({ 
                                    code: ord.code, 
                                    qty: netShares, 
                                    avg: newAvg, 
                                    mark: price, 
                                    mktVal: Math.abs(netShares) * price, 
                                    upl: 0, 
                                    uplPct: 0 
                                });
                            }
                        } else {
                            // Adding to existing position (same side)
                            const newTotalQty = exQty + (isBuy ? tradeQty : -tradeQty);
                            const newAvg = ((ex.avg * Math.abs(exQty)) + (price * tradeQty)) / Math.abs(newTotalQty);
                            nextPos[exIndex] = { ...ex, qty: newTotalQty, avg: newAvg };
                        }
                    } else if (tradeQty > 0) {
                        // Opening a new position
                        nextPos.push({ 
                            code: ord.code, 
                            qty: isBuy ? tradeQty : -tradeQty, 
                            avg: price, 
                            mark: price, 
                            mktVal: tradeAmt, 
                            upl: -comm, // Initial P/L is the commission
                            uplPct: 0 
                        });
                    }
                    return nextPos;
                });

                // Cash update includes transaction cost/proceeds and realized P/L
                setAccount(a => ({ 
                    ...a, 
                    cash: a.cash + transactionCostOrProceeds + realizedPL, 
                    realized: a.realized + realizedPL 
                }));
                notify(`成交: ${ord.side} ${tradeQty} ${ord.code} @ ${price.toFixed(2)} (實現盈虧: ${realizedPL.toFixed(2)})`);
            };

            const placeOrder = (e) => {
                e.preventDefault();
                const staticPrice = STATIC_PRICE;
                const price = order.type === 'MARKET' ? staticPrice : parseFloat(order.price);
                const qty = parseInt(order.qty);
                const currentCash = account.cash;
                
                if(!qty || qty <= 0) return notify("無效數量", "error");
                if(order.type==='LIMIT' && (!price || price <= 0)) return notify("無效價格", "error");

                const requiredFunds = order.side === 'BUY' ? staticPrice * qty : 0; 
                if (order.side === 'BUY' && requiredFunds > currentCash) return notify("購買力不足 (現金不足)", "error");

                // New order object
                const newOrd = { id: Math.random().toString(36).substr(2,9), time: new Date().toLocaleTimeString(), code: selCode, ...order, price, status: 'PENDING', fillPrice: 0 };

                // Instant Fill Logic (Static Market)
                const fill = order.type === 'MARKET' || (order.type === 'LIMIT' && price === staticPrice);
                
                if (fill) {
                    executeTrade(newOrd, staticPrice);
                } else if ((order.tif === 'IOC' || order.tif === 'FOK')) {
                    notify("訂單已取消 (缺乏流動性或價格不符)", "info");
                } else {
                    setOrders([newOrd, ...orders]);
                    notify("訂單已提交 (待市場價格觸發)");
                }
            };

            const cancelOrder = (id) => {
                setOrders(prev => prev.map(o => o.id === id && o.status === 'PENDING' ? { ...o, status: 'CXLD' } : o));
                notify("訂單已取消");
            };

            const notify = (msg, type='success') => {
                setMsg({ txt: msg, type });
                setTimeout(() => setMsg(null), 3000);
            };

            // --- DERIVED ---
            const selStock = stocks.find(s => s.c === selCode) || stocks[0];
            const activeOrders = orders.filter(o => o.status === 'PENDING');
            
            const setQtyByPct = (pct) => {
                const max = Math.floor(account.cash / STATIC_PRICE);
                setOrder(prev => ({ ...prev, qty: Math.floor(max * pct) }));
            };

            const filteredStocks = useMemo(() => {
                if (!searchQuery) return stocks;
                const query = searchQuery.toLowerCase();
                return stocks.filter(s => 
                    s.c.toLowerCase().includes(query) || 
                    s.n.toLowerCase().includes(query)
                );
            }, [stocks, searchQuery]);


            return (
                <div className="flex flex-col h-screen text-xs md:text-sm font-sans">
                    {/* --- HEADER: ACCOUNT SUMMARY --- */}
                    <header className="bg-gray-900 border-b border-gray-800 h-10 flex items-center justify-between px-3 shrink-0">
                        <div className="flex items-center gap-3">
                            <Icons.Settings className="text-blue-500"/>
                            <span className="font-bold text-gray-100 tracking-wide">PRO<span className="text-blue-500">TRADER</span> <span className="text-gray-600 text-[10px]">版面交換 v4</span></span>
                        </div>
                        <div className="flex gap-6 font-mono-num text-xs">
                            <div className="flex flex-col md:flex-row md:gap-2 items-end md:items-center">
                                <span className="text-gray-500 uppercase text-[10px]">Net Liq (淨資產)</span>
                                <span className="font-bold text-gray-200">{fmtUSD(account.netLiq)}</span>
                            </div>
                            <div className="flex flex-col md:flex-row md:gap-2 items-end md:items-center">
                                <span className="text-gray-500 uppercase text-[10px]">Day P/L (日盈虧)</span>
                                <span className={`font-bold ${col(account.dayPL)}`}>{fmtUSD(account.dayPL)}</span>
                            </div>
                            <div className="flex flex-col md:flex-row md:gap-2 items-end md:items-center">
                                <span className="text-gray-500 uppercase text-[10px]">Cash (現金)</span>
                                <span className="font-bold text-blue-400">{fmtUSD(account.cash)}</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 text-[10px] text-gray-500">
                            <Icons.Wifi className="text-gray-500" size={12}/>
                            <span>靜態連線</span>
                            <span className="font-mono text-gray-400">{time.toLocaleTimeString()}</span>
                        </div>
                    </header>

                    {/* --- MAIN DASHBOARD (3-Column Layout) --- */}
                    <div className="flex-1 flex overflow-hidden bg-[#0b0e11]">
                        
                        {/* 1. WATCHLIST (Left) - MLB Teams */}
                        <div className="w-60 flex flex-col border-r border-gray-800 bg-gray-900/50">
                            <div className="p-2 border-b border-gray-800">
                                <div className="relative">
                                    <Icons.Search className="absolute left-2 top-2.5 text-gray-500"/>
                                    <input 
                                        className="w-full bg-gray-950 border border-gray-700 rounded py-1.5 pl-7 pr-2 text-xs text-gray-300 focus:border-blue-500 outline-none" 
                                        placeholder="輸入代碼 / 名稱" 
                                        value={searchQuery}
                                        onChange={e => setSearchQuery(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                <div className="flex justify-between items-center px-3 py-1 bg-gray-900 border-b border-gray-700 text-gray-500 text-[10px] uppercase font-bold sticky top-0">
                                    <span>代碼/名稱</span>
                                    <span>市價 (靜態)</span>
                                </div>
                                {filteredStocks.map(s => (
                                    <div key={s.c} onClick={() => setSelCode(s.c)} className={`px-3 py-2 border-b border-gray-800/50 cursor-pointer hover:bg-gray-800 group ${selCode===s.c ? 'bg-blue-900/20 border-l-2 border-l-blue-500' : 'border-l-2 border-l-transparent'}`}>
                                        <div className="flex justify-between items-center">
                                            <span className="font-bold text-gray-200">{s.c}</span>
                                            <div className="flex flex-col items-end">
                                                <span className="font-mono-num text-gray-200 text-sm">{s.price.toFixed(2)}</span>
                                                <span className={`text-[9px] ${col(s.change)}`}>{s.change.toFixed(2)} ({s.pct.toFixed(2)}%)</span>
                                            </div>
                                        </div>
                                        <div className="text-[10px] text-gray-500 mt-0.5">
                                            <span className="truncate">{s.n}</span>
                                        </div>
                                    </div>
                                ))}
                                {filteredStocks.length === 0 && (
                                    <div className="text-center py-4 text-gray-600 italic">無符合結果</div>
                                )}
                            </div>
                        </div>

                        {/* 2. MARKET DATA (Center) - Quote Header, K-Line, Market Depth */}
                        <div className="flex-1 flex flex-col min-w-0 border-r border-gray-800 bg-gray-900/30">
                            
                            {/* Detailed Quote Header */}
                            <div className="p-3 border-b border-gray-800 bg-gray-900/50 shrink-0">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="text-xl font-bold text-white">{selStock.c}</span>
                                    <span className="text-xs text-gray-500">{selStock.n}</span>
                                </div>
                                
                                <div className="flex items-end justify-between">
                                    <div className="flex flex-col">
                                        <span className="text-4xl font-mono-num font-bold text-gray-200">
                                            {selStock.price.toFixed(2)}
                                        </span>
                                        <span className={`text-sm font-mono-num ${col(selStock.change)}`}>
                                            {selStock.change.toFixed(2)} ({selStock.pct.toFixed(2)}%)
                                        </span>
                                    </div>
                                    
                                    {/* Quote Details Table */}
                                    <div className="grid grid-cols-3 gap-x-4 gap-y-1 text-xs text-gray-500 font-mono-num">
                                        <span className="text-gray-600">開盤:</span><span className="text-right text-gray-300">{selStock.open.toFixed(2)}</span>
                                        <span className="text-gray-600">成交量:</span><span className="text-right text-gray-300">{selStock.vol}</span>
                                        <span className="text-gray-600">最高:</span><span className="text-right text-gray-300">{selStock.high.toFixed(2)}</span>
                                        <span className="text-gray-600">最低:</span><span className="text-right text-gray-300">{selStock.low.toFixed(2)}</span>
                                        <span className="text-gray-600">參考價:</span><span className="text-right text-gray-300">{selStock.refPrice.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>

                            {/* K-Line Chart Area (K線圖) */}
                            <div className="h-48 border-b border-gray-800 bg-gray-950 flex items-center justify-center p-2 shrink-0">
                                <KLineChart price={selStock.price} />
                            </div>
                            
                            {/* Market Depth / 各隊委託狀態區 */}
                            <div className="flex-1 flex flex-col min-h-0">
                                <div className="px-3 py-1.5 bg-gray-800/50 text-[10px] font-bold text-gray-400 uppercase border-b border-gray-800 flex items-center gap-2 shrink-0">
                                    各隊委託狀態區 (Market Depth)
                                </div>
                                <MarketDepth price={selStock.price} />
                            </div>

                        </div>

                        {/* 3. TRADING CONTROLS (Right) - Order Entry, Positions, Orders */}
                        <div className="w-72 flex flex-col shrink-0 bg-gray-900/70">
                            
                            {/* Order Entry Form */}
                            <OrderEntryForm 
                                order={order} 
                                selCode={selCode} 
                                account={account} 
                                setOrder={setOrder} 
                                placeOrder={placeOrder} 
                                notify={notify} 
                                setQtyByPct={setQtyByPct}
                            />
                            
                            {/* Positions */}
                            <div className="flex flex-col border-b border-gray-800 min-h-0 flex-1">
                                <div className="px-3 py-1.5 bg-gray-800/50 text-[10px] font-bold text-gray-400 uppercase border-b border-gray-800 flex items-center gap-2 shrink-0">
                                    <Icons.Briefcase size={12}/> 部位 (Positions)
                                </div>
                                <div className="flex-1 overflow-y-auto min-h-[100px]">
                                    <table className="w-full text-left text-[11px]">
                                        <thead className="text-gray-500 sticky top-0 bg-[#0b0e11]">
                                            <tr><th className="pl-3 py-1">代碼</th><th className="text-right">數量</th><th className="text-right">成本</th><th className="text-right pr-3">未實現P/L</th></tr>
                                        </thead>
                                        <tbody className="font-mono-num divide-y divide-gray-800/50">
                                            {pos.map(p => (
                                                <tr key={p.code} className="hover:bg-gray-800/30 cursor-pointer" onClick={() => setSelCode(p.code)}>
                                                    <td className="pl-3 py-1 text-gray-300 font-bold">{p.code}</td>
                                                    <td className={`text-right ${p.qty>0?'text-green-400':'text-red-400'}`}>{p.qty}</td>
                                                    <td className="text-right text-gray-500">{p.avg.toFixed(2)}</td>
                                                    <td className={`text-right pr-3 ${col(p.upl)}`}>{p.upl.toFixed(2)}</td>
                                                </tr>
                                            ))}
                                            {pos.length === 0 && <tr><td colSpan="5" className="text-center py-4 text-gray-600 italic">無持有部位</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Working Orders */}
                            <div className="flex flex-col min-h-0 flex-1">
                                <div className="px-3 py-1.5 bg-gray-800/50 text-[10px] font-bold text-gray-400 uppercase border-b border-gray-800 flex items-center gap-2 shrink-0">
                                    委託單 (Working Orders)
                                </div>
                                <div className="flex-1 overflow-y-auto min-h-[100px]">
                                    <table className="w-full text-left text-[11px]">
                                        <thead className="text-gray-500 sticky top-0 bg-[#0b0e11]">
                                            <tr><th>方向</th><th>代碼</th><th className="text-right">價格</th><th className="text-right">數量</th><th className="text-center pr-2">取消</th></tr>
                                        </thead>
                                        <tbody className="font-mono-num divide-y divide-gray-800/50">
                                            {activeOrders.map(o => (
                                                <tr key={o.id} className="hover:bg-gray-800/30">
                                                    <td className={`pl-3 py-1 ${o.side==='BUY'?'text-green-500':'text-red-500'}`}>{o.side==='BUY'?'買':'賣'}</td>
                                                    <td className="text-gray-300">{o.code}</td>
                                                    <td className="text-right text-gray-300">{o.price.toFixed(2)}</td>
                                                    <td className="text-right text-gray-300">{o.qty}</td>
                                                    <td className="text-center">
                                                        <button onClick={() => cancelOrder(o.id)} className="text-red-500 hover:text-red-300 p-1 rounded transition-colors">
                                                            <Icons.X size={12}/>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {activeOrders.length === 0 && <tr><td colSpan="5" className="text-center py-4 text-gray-600 italic">無待處理委託單</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* --- FOOTER: NOTIFICATIONS --- */}
                    {msg && (
                        <div className={`absolute bottom-4 right-4 p-3 rounded-lg shadow-2xl transition-all ${msg.type === 'error' ? 'bg-red-600' : msg.type === 'info' ? 'bg-blue-600' : 'bg-green-600'} text-white font-bold`}>
                            {msg.txt}
                        </div>
                    )}
                </div>
            );
        }

        // --- RENDER APP ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
