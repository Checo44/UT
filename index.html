<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTrader: MLB Edition (Direct Access)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Professional Dark Theme tweaks */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Roboto Mono", "Segoe UI", Helvetica, Arial, sans-serif; 
            background-color: #0b0e11; /* Deep Brokerage Black */
        }
        .font-mono-num { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Scrollbar - Slim & Dark */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* Utility for depth bars */
        .depth-bar-bid { background: linear-gradient(90deg, rgba(34,197,94,0.15) 0%, rgba(34,197,94,0.05) 100%); }
        .depth-bar-ask { background: linear-gradient(90deg, rgba(239,68,68,0.15) 0%, rgba(239,68,68,0.05) 100%); }
    </style>
</head>
<body class="text-gray-300 overflow-hidden selection:bg-blue-500/30 selection:text-blue-200">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const apiKey = ""; 

        // --- ICONS (Lucide) ---
        const Icon = ({ d, size=16, className, children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {d && <path d={d}/>}
                {children}
            </svg>
        );

        const Icons = {
            Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Chart: (p) => <Icon {...p} d="M3 3v18h18 M18 17V9 M13 17V5 M8 17v-3"/>,
            List: (p) => <Icon {...p} d="M8 6h13 M8 12h13 M8 18h13 M3 6h.01 M3 12h.01 M3 18h.01"/>,
            Briefcase: (p) => <Icon {...p} d="M20 7h-3a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>,
            X: (p) => <Icon {...p} d="M18 6L6 18 M6 6l12 12"/>,
            Sparkles: (p) => <Icon {...p} d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>,
            Send: (p) => <Icon {...p} d="M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z"/>,
            Settings: (p) => (
                <Icon {...p} d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V4a2 2 0 0 0-2-2z">
                    <circle cx="12" cy="12" r="3"/>
                </Icon>
            ),
            Wifi: (p) => <Icon {...p} d="M5 12.55a11 11 0 0 1 14.08 0 M1.42 9a16 16 0 0 1 21.16 0 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01"/>
        };

        // --- CONSTANTS & HELPERS ---
        const INITIAL_CASH = 100000.00;
        const INITIAL_DATA = [
            { c:'NYY', n:'NY Yankees', p:158.20 }, { c:'LAD', n:'LA Dodgers', p:185.50 },
            { c:'BOS', n:'Boston Red Sox', p:95.40 }, { c:'ATL', n:'Atlanta Braves', p:120.10 },
            { c:'HOU', n:'Houston Astros', p:110.35 }, { c:'PHI', n:'Phila Phillies', p:105.80 },
            { c:'BAL', n:'Baltimore Orioles', p:88.20 }, { c:'CHC', n:'Chi Cubs', p:75.60 },
            { c:'TOR', n:'Toronto Blue Jays', p:65.40 }, { c:'NYM', n:'NY Mets', p:92.15 },
            { c:'SF', n:'SF Giants', p:82.30 }, { c:'SD', n:'SD Padres', p:98.50 },
            { c:'TEX', n:'Texas Rangers', p:78.90 }, { c:'SEA', n:'Seattle Mariners', p:68.45 },
            { c:'STL', n:'St. Louis Cardinals', p:72.10 }, { c:'TB', n:'Tampa Bay Rays', p:55.30 },
            { c:'MIN', n:'Minnesota Twins', p:48.90 }, { c:'CLE', n:'Guardians', p:52.40 },
            { c:'MIL', n:'Milwaukee Brewers', p:50.10 }, { c:'ARI', n:'Arizona D-backs', p:58.60 },
            { c:'MIA', n:'Miami Marlins', p:25.30 }, { c:'CIN', n:'Cincinnati Reds', p:32.15 },
            { c:'DET', n:'Detroit Tigers', p:28.90 }, { c:'PIT', n:'Pittsburgh Pirates', p:22.40 },
            { c:'WSH', n:'Washington Nationals', p:35.60 }, { c:'LAA', n:'LA Angels', p:45.20 },
            { c:'KC', n:'KC Royals', p:38.50 }, { c:'COL', n:'Colorado Rockies', p:29.80 },
            { c:'CWS', n:'Chi White Sox', p:18.20 }, { c:'OAK', n:'Oakland Athletics', p:15.10 },
        ];

        const fmtUSD = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(n);
        const fmtPct = (n) => `${n > 0 ? '+' : ''}${n.toFixed(2)}%`;
        const col = (n) => n > 0 ? 'text-green-500' : n < 0 ? 'text-red-500' : 'text-gray-400';

        // --- CANDLESTICK CHART COMPONENT ---
        const CandlestickChart = ({ data }) => {
            const containerRef = useRef(null);
            const [dims, setDims] = useState({ w: 0, h: 0 });

            // Use ResizeObserver to handle dynamic sizing issues
            useEffect(() => {
                if (!containerRef.current) return;
                
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const { width, height } = entry.contentRect;
                        if (width > 0 && height > 0) {
                            setDims({ w: width, h: height });
                        }
                    }
                });
                
                resizeObserver.observe(containerRef.current);
                return () => resizeObserver.disconnect();
            }, []);

            if (!data || data.length < 2) return <div className="h-full flex items-center justify-center text-xs text-gray-600 animate-pulse">LOADING DATA...</div>;

            const { w, h } = dims;
            // If dimensions are still 0 (initial render), don't render chart content yet
            if (w === 0 || h === 0) return <div ref={containerRef} className="w-full h-full" />;

            const pT=20, pB=30, pR=50, pL=10;
            const cW = w - pL - pR;
            const cH = h - pT - pB;

            // Visible window: Last 60 candles max
            const visibleData = data.slice(-60);
            const minP = Math.min(...visibleData.map(d => d.l)) * 0.999;
            const maxP = Math.max(...visibleData.map(d => d.h)) * 1.001;
            const range = maxP - minP || 1;
            
            const maxVol = Math.max(...visibleData.map(d => d.v)) || 1;

            const getX = (i) => pL + (i / Math.max(visibleData.length - 1, 1)) * cW;
            const getY = (p) => pT + cH - ((p - minP) / range) * cH;
            
            // Calculate MA5
            const ma5 = visibleData.map((d, i, arr) => {
                if(i < 4) return null;
                const sum = arr.slice(i-4, i+1).reduce((a,b) => a + b.c, 0);
                return sum/5;
            });

            return (
                <div ref={containerRef} className="w-full h-full relative select-none">
                    <svg width={w} height={h} className="overflow-visible">
                        {/* Grid & Prices (Y-Axis) */}
                        {[0, 0.25, 0.5, 0.75, 1].map(tick => {
                            const p = minP + range * tick;
                            const y = getY(p);
                            return (
                                <g key={tick}>
                                    <line x1={pL} y1={y} x2={w-pR} y2={y} stroke="#1f2937" strokeDasharray="2"/>
                                    <text x={w} y={y} fontSize="10" fill="#6b7280" textAnchor="end" alignmentBaseline="middle" className="font-mono-num">{p.toFixed(2)}</text>
                                </g>
                            );
                        })}

                        {/* Candles */}
                        {visibleData.map((d, i) => {
                            const x = getX(i);
                            const barW = Math.max(1, (cW / visibleData.length) * 0.7);
                            const isUp = d.c >= d.o;
                            const color = isUp ? "#22c55e" : "#ef4444";
                            const yHigh = getY(d.h);
                            const yLow = getY(d.l);
                            const yOpen = getY(d.o);
                            const yClose = getY(d.c);
                            
                            // Volume Bar
                            const volH = (d.v / maxVol) * (cH * 0.3); // Max 30% height
                            
                            return (
                                <g key={i}>
                                    {/* Volume */}
                                    <rect x={x - barW/2} y={h - pB - volH} width={barW} height={volH} fill={color} opacity="0.2" />
                                    {/* Wick */}
                                    <line x1={x} y1={yHigh} x2={x} y2={yLow} stroke={color} strokeWidth="1" />
                                    {/* Body */}
                                    <rect 
                                        x={x - barW/2} 
                                        y={Math.min(yOpen, yClose)} 
                                        width={barW} 
                                        height={Math.max(Math.abs(yOpen - yClose), 1)} 
                                        fill={color} 
                                    />
                                </g>
                            )
                        })}

                        {/* MA5 Line */}
                        <polyline 
                            points={ma5.map((v, i) => v ? `${getX(i)},${getY(v)}` : null).filter(x=>x).join(' ')}
                            fill="none" stroke="#fbbf24" strokeWidth="1" opacity="0.8"
                        />
                        
                        {/* Current Price Indicator */}
                        <line x1={pL} y1={getY(visibleData[visibleData.length-1].c)} x2={w-pR} y2={getY(visibleData[visibleData.length-1].c)} stroke="#3b82f6" strokeWidth="1" strokeDasharray="4" opacity="0.5"/>
                    </svg>
                    {/* Labels */}
                    <div className="absolute top-2 left-2 flex gap-4 text-[10px] font-mono text-gray-500">
                        <span className="text-yellow-500">MA(5)</span>
                        <span>VOL</span>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            // State
            const [time, setTime] = useState(new Date());
            const [stocks, setStocks] = useState(INITIAL_DATA.map(s => ({ ...s, price: s.p, high: s.p, low: s.p, open: s.p, vol: 0, change: 0, pct: 0 })));
            const [selCode, setSelCode] = useState('NYY');
            const [history, setHistory] = useState({}); // { CODE: [{o,h,l,c,v,time}] }
            const [account, setAccount] = useState({ cash: INITIAL_CASH, equity: INITIAL_CASH, realized: 0 });
            const [pos, setPos] = useState([]);
            const [orders, setOrders] = useState([]);
            const [aiOpen, setAiOpen] = useState(false);
            
            // Order Entry State
            const [order, setOrder] = useState({ side: 'BUY', type: 'LIMIT', tif: 'DAY', qty: '', price: '' });
            const [msg, setMsg] = useState(null);

            // --- ENGINE: TICK & CANDLE GENERATION ---
            useEffect(() => {
                // Init History
                const initHist = {};
                stocks.forEach(s => {
                    // Generate dummy history
                    const arr = [];
                    let p = s.p;
                    for(let i=0; i<100; i++) {
                        let o = p;
                        let c = o * (1 + (Math.random()-0.5)*0.004);
                        let h = Math.max(o, c) * (1 + Math.random()*0.001);
                        let l = Math.min(o, c) * (1 - Math.random()*0.001);
                        arr.push({ o, h, l, c, v: Math.floor(Math.random()*1000), time: Date.now()-i*60000 });
                        p = c;
                    }
                    initHist[s.c] = arr.reverse();
                });
                setHistory(initHist);

                const interval = setInterval(() => {
                    setTime(new Date());
                    
                    // Market Simulation
                    setStocks(prev => {
                        const updated = prev.map(s => {
                            if(Math.random() > 0.3) { // 70% chance to tick
                                const move = (Math.random() - 0.5) * 0.05; // volatility
                                let np = s.price + move;
                                np = Math.round(np * 100) / 100;
                                return {
                                    ...s,
                                    price: np,
                                    high: Math.max(s.high, np),
                                    low: Math.min(s.low, np),
                                    vol: s.vol + Math.floor(Math.random() * 50),
                                    change: np - s.p, // s.p is ref price (prev close)
                                    pct: (np - s.p)/s.p * 100
                                };
                            }
                            return s;
                        });

                        // Update Candle History (Real-time accumulation simulation)
                        setHistory(prevH => {
                            const newH = { ...prevH };
                            updated.forEach(s => {
                                if(!newH[s.c]) return;
                                const last = newH[s.c][newH[s.c].length - 1];
                                // Simple logic: update last candle or create new every 3 seconds for demo speed
                                if (Date.now() - last.time < 3000) {
                                    last.c = s.price;
                                    last.h = Math.max(last.h, s.price);
                                    last.l = Math.min(last.l, s.price);
                                    last.v += (s.vol - (updated.find(u=>u.c===s.c)?.oldVol || s.vol)); // approx delta
                                } else {
                                    newH[s.c] = [...newH[s.c], { o: s.price, h: s.price, l: s.price, c: s.price, v: 0, time: Date.now() }].slice(-100);
                                }
                            });
                            return newH;
                        });
                        return updated;
                    });
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // --- MATCHING ENGINE ---
            useEffect(() => {
                setOrders(prev => {
                    let dirty = false;
                    const next = prev.map(o => {
                        if(o.status !== 'PENDING') return o;
                        const s = stocks.find(x => x.c === o.code);
                        if(!s) return o;
                        
                        // Check fill
                        const fill = (o.side === 'BUY' && s.price <= o.price) || (o.side === 'SELL' && s.price >= o.price);
                        if (fill || o.type === 'MARKET') {
                            dirty = true;
                            executeTrade(o, s.price);
                            return { ...o, status: 'FILLED', fillPrice: s.price };
                        }
                        return o;
                    });
                    return dirty ? next : prev;
                });
            }, [stocks]);

            // --- P/L CALC ---
            useEffect(() => {
                setPos(prev => prev.map(p => {
                    const s = stocks.find(x => x.c === p.code);
                    if(!s) return p;
                    const mkt = Math.abs(p.qty) * s.price;
                    const upl = p.qty > 0 ? (s.price - p.avg) * p.qty : (p.avg - s.price) * Math.abs(p.qty);
                    return { ...p, mark: s.price, mktVal: mkt, upl, uplPct: (upl/(p.avg*Math.abs(p.qty)))*100 };
                }));
            }, [stocks]);

            useEffect(() => {
                const uplTotal = pos.reduce((a,b) => a + b.upl, 0);
                setAccount(a => ({ ...a, equity: a.cash + uplTotal + pos.reduce((acc,p) => acc + (p.qty > 0 ? p.mktVal : 0), 0) })); // Simplified Equity
            }, [pos, account.cash]);

            // --- ACTIONS ---
            const executeTrade = (ord, price) => {
                const qty = parseInt(ord.qty);
                const amt = price * qty;
                const comm = Math.max(1, qty * 0.005); // Commission
                
                setPos(prev => {
                    const ex = prev.find(p => p.code === ord.code);
                    if(!ex) {
                        return [...prev, { code: ord.code, qty: ord.side==='BUY'?qty:-qty, avg: price, mark: price, mktVal: amt, upl: -comm, uplPct: 0 }];
                    } else {
                        const newQty = ex.qty + (ord.side==='BUY'?qty:-qty);
                        if (newQty === 0) return prev.filter(p => p.code !== ord.code);
                        // Weighted Avg Cost logic skipped for brevity, using last price for simplicity in this demo
                        return prev.map(p => p.code === ord.code ? { ...p, qty: newQty } : p);
                    }
                });
                setAccount(a => ({ ...a, cash: a.cash + (ord.side==='BUY' ? -amt : amt) - comm }));
                notify(`FILLED: ${ord.side} ${qty} ${ord.code} @ ${price}`);
            };

            const placeOrder = (e) => {
                e.preventDefault();
                const s = stocks.find(x => x.c === selCode);
                const price = order.type === 'MARKET' ? s.price : parseFloat(order.price);
                const qty = parseInt(order.qty);
                
                if(!qty || qty <= 0) return notify("Invalid Qty", "error");
                if(order.type==='LIMIT' && !price) return notify("Invalid Price", "error");

                // Buying Power Check
                if (order.side === 'BUY' && (price * qty) > account.cash) return notify("Insufficient Buying Power", "error");

                const newOrd = {
                    id: Math.random().toString(36).substr(2,9),
                    time: new Date().toLocaleTimeString(),
                    code: selCode,
                    ...order,
                    price,
                    status: 'PENDING',
                    fillPrice: 0
                };

                // Immediate check for Market or matching Limit
                const fill = order.type === 'MARKET' || (order.side==='BUY' && s.price <= price) || (order.side==='SELL' && s.price >= price);
                
                if ((order.tif === 'IOC' || order.tif === 'FOK') && !fill) {
                    notify("Order Cancelled (No Liquidity)", "info");
                } else if (fill && order.type === 'MARKET') {
                    executeTrade(newOrd, s.price);
                } else {
                    setOrders([newOrd, ...orders]);
                    notify("Order Submitted");
                }
            };

            const cancelOrder = (id) => {
                setOrders(prev => prev.map(o => o.id === id && o.status === 'PENDING' ? { ...o, status: 'CXLD' } : o));
                notify("Order Cancelled");
            };

            const notify = (msg, type='success') => {
                setMsg({ txt: msg, type });
                setTimeout(() => setMsg(null), 3000);
            };

            // --- DERIVED ---
            const selStock = stocks.find(s => s.c === selCode) || stocks[0];
            const activeOrders = orders.filter(o => o.status === 'PENDING');
            const currentPos = pos.find(p => p.code === selCode);

            // Smart Qty Helper
            const setQtyByPct = (pct) => {
                const s = stocks.find(x => x.c === selCode);
                const p = order.price || s.price;
                const max = Math.floor(account.cash / p);
                setOrder(prev => ({ ...prev, qty: Math.floor(max * pct) }));
            };

            // Simulated Depth
            const DepthRow = ({ price, size, type }) => {
                const w = Math.min((size / 1000) * 100, 100);
                return (
                    <div className="flex justify-between text-xs font-mono relative py-0.5 px-1 hover:bg-gray-800 cursor-pointer" onClick={() => setOrder(p => ({...p, price: price.toFixed(2), type: 'LIMIT'}))}>
                        <div className={`absolute top-0 bottom-0 opacity-20 ${type==='bid'?'right-1/2 bg-green-500 origin-right':'left-1/2 bg-red-500 origin-left'}`} style={{width: `${w}%`}}></div>
                        <span className="w-1/2 text-right pr-2 text-gray-400">{type==='bid'?size:price.toFixed(2)}</span>
                        <span className={`w-1/2 pl-2 ${type==='bid'?'text-green-400':'text-gray-400'}`}>{type==='bid'?price.toFixed(2):size}</span>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-screen text-xs md:text-sm font-sans">
                    {/* --- HEADER: ACCOUNT SUMMARY --- */}
                    <header className="bg-gray-900 border-b border-gray-800 h-10 flex items-center justify-between px-3 shrink-0">
                        <div className="flex items-center gap-3">
                            <Icons.Settings className="text-blue-500"/>
                            <span className="font-bold text-gray-100 tracking-wide">PRO<span className="text-blue-500">TRADER</span> <span className="text-gray-600 text-[10px]">MLB DMA</span></span>
                        </div>
                        <div className="flex gap-6 font-mono-num text-xs">
                            <div className="flex flex-col md:flex-row md:gap-2 items-end md:items-center">
                                <span className="text-gray-500 uppercase text-[10px]">Net Liq</span>
                                <span className="font-bold text-gray-200">{fmtUSD(account.equity)}</span>
                            </div>
                            <div className="flex flex-col md:flex-row md:gap-2 items-end md:items-center">
                                <span className="text-gray-500 uppercase text-[10px]">Day P/L</span>
                                <span className={`font-bold ${col(account.equity - INITIAL_CASH)}`}>{fmtUSD(account.equity - INITIAL_CASH)}</span>
                            </div>
                            <div className="flex flex-col md:flex-row md:gap-2 items-end md:items-center">
                                <span className="text-gray-500 uppercase text-[10px]">Buying Power</span>
                                <span className="font-bold text-blue-400">{fmtUSD(account.cash)}</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 text-[10px] text-gray-500">
                            <Icons.Wifi className="text-green-500" size={12}/>
                            <span>Connected</span>
                            <span className="font-mono text-gray-400">{time.toLocaleTimeString()}</span>
                        </div>
                    </header>

                    {/* --- MAIN DASHBOARD --- */}
                    <div className="flex-1 flex overflow-hidden bg-[#0b0e11]">
                        
                        {/* 1. WATCHLIST (Left) */}
                        <div className="w-60 flex flex-col border-r border-gray-800 bg-gray-900/50">
                            <div className="p-2 border-b border-gray-800">
                                <div className="relative">
                                    <Icons.Search className="absolute left-2 top-2 text-gray-500"/>
                                    <input className="w-full bg-gray-950 border border-gray-700 rounded py-1 pl-7 pr-2 text-xs text-gray-300 focus:border-blue-500 outline-none" placeholder="Symbol" />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {stocks.map(s => (
                                    <div key={s.c} onClick={() => setSelCode(s.c)} className={`px-3 py-2 border-b border-gray-800/50 cursor-pointer hover:bg-gray-800 group ${selCode===s.c ? 'bg-blue-900/20 border-l-2 border-l-blue-500' : 'border-l-2 border-l-transparent'}`}>
                                        <div className="flex justify-between items-center">
                                            <span className="font-bold text-gray-200">{s.c}</span>
                                            <span className={`font-mono-num ${col(s.change)}`}>{s.price.toFixed(2)}</span>
                                        </div>
                                        <div className="flex justify-between text-[10px] text-gray-500 mt-0.5">
                                            <span className="truncate w-20">{s.n}</span>
                                            <span className={`${col(s.change)} group-hover:text-white`}>{fmtPct(s.pct)}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 2. CHART & DOM (Center) */}
                        <div className="flex-1 flex flex-col min-w-0 border-r border-gray-800">
                            {/* Chart Header */}
                            <div className="h-12 border-b border-gray-800 flex justify-between items-center px-4 bg-gray-900/30">
                                <div>
                                    <span className="text-xl font-bold text-white mr-2">{selStock.c}</span>
                                    <span className="text-xs text-gray-500 mr-4">{selStock.n}</span>
                                    <span className={`text-lg font-mono-num font-bold ${col(selStock.change)}`}>{selStock.price.toFixed(2)}</span>
                                    <span className={`ml-2 text-xs font-mono-num ${col(selStock.change)}`}>{fmtPct(selStock.pct)}</span>
                                </div>
                                <div className="flex gap-4 text-xs font-mono text-gray-500">
                                    <div>H: <span className="text-gray-300">{selStock.high.toFixed(2)}</span></div>
                                    <div>L: <span className="text-gray-300">{selStock.low.toFixed(2)}</span></div>
                                    <div>V: <span className="text-gray-300">{selStock.vol.toLocaleString()}</span></div>
                                </div>
                            </div>
                            
                            {/* Chart Container */}
                            <div className="flex-1 relative bg-[#0b0e11]">
                                <CandlestickChart data={history[selCode]} />
                            </div>

                            {/* Bottom Split: Positions & Orders */}
                            <div className="h-1/3 min-h-[200px] border-t border-gray-800 flex">
                                {/* Positions Col */}
                                <div className="flex-1 border-r border-gray-800 flex flex-col bg-gray-900/20">
                                    <div className="px-3 py-1.5 bg-gray-800/50 text-[10px] font-bold text-gray-400 uppercase border-b border-gray-800 flex items-center gap-2">
                                        <Icons.Briefcase size={12}/> Positions
                                    </div>
                                    <div className="flex-1 overflow-y-auto">
                                        <table className="w-full text-left text-[11px]">
                                            <thead className="text-gray-500 sticky top-0 bg-[#0b0e11]">
                                                <tr>
                                                    <th className="pl-3 py-1">Sym</th>
                                                    <th className="text-right">Qty</th>
                                                    <th className="text-right">Avg</th>
                                                    <th className="text-right">Last</th>
                                                    <th className="text-right pr-3">P/L</th>
                                                </tr>
                                            </thead>
                                            <tbody className="font-mono-num divide-y divide-gray-800/50">
                                                {pos.map(p => (
                                                    <tr key={p.code} className="hover:bg-gray-800/30 cursor-pointer" onClick={() => setSelCode(p.code)}>
                                                        <td className="pl-3 py-1 text-gray-300 font-bold">{p.code}</td>
                                                        <td className={`text-right ${p.qty>0?'text-blue-400':'text-purple-400'}`}>{p.qty}</td>
                                                        <td className="text-right text-gray-500">{p.avg.toFixed(2)}</td>
                                                        <td className="text-right text-gray-300">{p.mark.toFixed(2)}</td>
                                                        <td className={`text-right pr-3 ${col(p.upl)}`}>{p.upl.toFixed(2)}</td>
                                                    </tr>
                                                ))}
                                                {pos.length === 0 && <tr><td colSpan="5" className="text-center py-4 text-gray-600 italic">Flat</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Active Orders Col */}
                                <div className="flex-1 flex flex-col bg-gray-900/20">
                                    <div className="px-3 py-1.5 bg-gray-800/50 text-[10px] font-bold text-gray-400 uppercase border-b border-gray-800 flex items-center gap-2">
                                        <Icons.List size={12}/> Working Orders
                                    </div>
                                    <div className="flex-1 overflow-y-auto">
                                        <table className="w-full text-left text-[11px]">
                                            <thead className="text-gray-500 sticky top-0 bg-[#0b0e11]">
                                                <tr>
                                                    <th className="pl-3 py-1">Time</th>
                                                    <th>Side</th>
                                                    <th>Sym</th>
                                                    <th className="text-right">Px</th>
                                                    <th className="text-right">Qty</th>
                                                    <th className="text-center pr-2">cx</th>
                                                </tr>
                                            </thead>
                                            <tbody className="font-mono-num divide-y divide-gray-800/50">
                                                {activeOrders.map(o => (
                                                    <tr key={o.id} className="hover:bg-gray-800/30">
                                                        <td className="pl-3 py-1 text-gray-500">{o.time.split(' ')[0]}</td>
                                                        <td className={o.side==='BUY'?'text-green-500':'text-red-500'}>{o.side}</td>
                                                        <td className="text-gray-300">{o.code}</td>
                                                        <td className="text-right">{o.type==='MARKET'?'MKT':o.price.toFixed(2)}</td>
                                                        <td className="text-right text-white">{o.qty}</td>
                                                        <td className="text-center pr-2">
                                                            <button onClick={()=>cancelOrder(o.id)} className="text-gray-600 hover:text-red-400"><Icons.X size={12}/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 3. ORDER ENTRY & DEPTH (Right - Fixed Width) */}
                        <div className="w-72 flex flex-col bg-gray-900/80 border-l border-gray-800">
                            
                            {/* Level 2 DOM */}
                            <div className="flex-1 flex flex-col overflow-hidden border-b border-gray-800">
                                <div className="px-2 py-1 bg-gray-950 text-[10px] text-gray-500 font-bold flex justify-between">
                                    <span>BID SIZE</span><span>PRICE</span><span>ASK SIZE</span>
                                </div>
                                <div className="flex-1 overflow-y-auto bg-[#0b0e11] flex flex-col justify-center relative">
                                    {/* Asks (Top) */}
                                    {[4,3,2,1,0].map(i => {
                                        const p = selStock.price + (i+1)*0.01;
                                        const sz = Math.floor(Math.random()*2000)+100;
                                        return <DepthRow key={`ask${i}`} price={p} size={sz} type="ask"/>
                                    })}
                                    
                                    {/* Spread */}
                                    <div className="py-1 bg-gray-800 text-center font-bold text-white border-y border-gray-700 text-sm">{selStock.price.toFixed(2)}</div>
                                    
                                    {/* Bids (Bottom) */}
                                    {[0,1,2,3,4].map(i => {
                                        const p = selStock.price - (i+1)*0.01;
                                        const sz = Math.floor(Math.random()*2000)+100;
                                        return <DepthRow key={`bid${i}`} price={p} size={sz} type="bid"/>
                                    })}
                                </div>
                            </div>

                            {/* Order Entry Form */}
                            <div className="p-3 bg-gray-900">
                                <div className="flex justify-between mb-2 text-xs">
                                    <span className="font-bold text-gray-300">Order Ticket</span>
                                    {currentPos && <span className={currentPos.qty>0?'text-blue-400':'text-purple-400'}>{currentPos.qty} SHRS</span>}
                                </div>
                                
                                <form onSubmit={placeOrder} className="space-y-2">
                                    <div className="flex gap-1 p-1 bg-black rounded border border-gray-700">
                                        <button type="button" onClick={()=>setOrder(p=>({...p, side:'BUY'}))} className={`flex-1 py-1 text-xs font-bold rounded ${order.side==='BUY'?'bg-green-600 text-white':'text-gray-500 hover:text-gray-300'}`}>BUY</button>
                                        <button type="button" onClick={()=>setOrder(p=>({...p, side:'SELL'}))} className={`flex-1 py-1 text-xs font-bold rounded ${order.side==='SELL'?'bg-red-600 text-white':'text-gray-500 hover:text-gray-300'}`}>SELL</button>
                                    </div>

                                    <div className="grid grid-cols-2 gap-2">
                                        <div className="space-y-1">
                                            <label className="text-[10px] text-gray-500">Shares</label>
                                            <input type="number" value={order.qty} onChange={e=>setOrder(p=>({...p, qty:e.target.value}))} className="w-full bg-black border border-gray-700 rounded px-2 py-1 text-right text-white text-sm outline-none focus:border-blue-500" />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[10px] text-gray-500">Price</label>
                                            <input type="number" disabled={order.type==='MARKET'} value={order.price} onChange={e=>setOrder(p=>({...p, price:e.target.value}))} className="w-full bg-black border border-gray-700 rounded px-2 py-1 text-right text-white text-sm outline-none focus:border-blue-500 disabled:opacity-50" placeholder={order.type==='MARKET'?'MKT':''} />
                                        </div>
                                    </div>

                                    {/* Quick Size Buttons */}
                                    <div className="flex gap-1">
                                        {[0.25, 0.5, 1].map(pct => (
                                            <button key={pct} type="button" onClick={()=>setQtyByPct(pct)} className="flex-1 bg-gray-800 hover:bg-gray-700 text-[10px] text-gray-400 rounded py-0.5 border border-gray-700">{pct*100}%</button>
                                        ))}
                                    </div>

                                    <div className="flex gap-2">
                                        <select value={order.type} onChange={e=>setOrder(p=>({...p, type:e.target.value}))} className="flex-1 bg-gray-800 border border-gray-700 rounded text-xs text-white px-1 py-1 outline-none">
                                            <option value="LIMIT">LMT</option>
                                            <option value="MARKET">MKT</option>
                                        </select>
                                        <select value={order.tif} onChange={e=>setOrder(p=>({...p, tif:e.target.value}))} className="flex-1 bg-gray-800 border border-gray-700 rounded text-xs text-white px-1 py-1 outline-none">
                                            <option value="DAY">DAY</option>
                                            <option value="IOC">IOC</option>
                                            <option value="FOK">FOK</option>
                                        </select>
                                    </div>

                                    <button type="submit" className={`w-full py-3 rounded font-bold text-sm text-white shadow-lg mt-2 ${order.side==='BUY'?'bg-green-700 hover:bg-green-600':'bg-red-700 hover:bg-red-600'}`}>
                                        {order.side}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    {/* AI BTN */}
                    <button onClick={()=>setAiOpen(true)} className="fixed bottom-4 right-4 p-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-xl border border-indigo-400/30 z-50 transition-all hover:scale-105">
                        <Icons.Sparkles/>
                    </button>

                    {/* AI MODAL */}
                    {aiOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100]">
                            <div className="bg-gray-900 border border-gray-700 w-96 rounded-lg shadow-2xl overflow-hidden">
                                <div className="bg-gray-800 p-3 flex justify-between items-center border-b border-gray-700">
                                    <div className="flex items-center gap-2 text-white font-bold"><Icons.Sparkles className="text-indigo-400"/> Gemini Analyst</div>
                                    <button onClick={()=>setAiOpen(false)} className="text-gray-500 hover:text-white"><Icons.X/></button>
                                </div>
                                <div className="p-4 h-64 overflow-y-auto text-sm text-gray-300">
                                    <p className="mb-2">Analyzing <strong>{selStock.n} ({selStock.c})</strong>...</p>
                                    <div className="p-3 bg-indigo-900/20 border border-indigo-500/30 rounded text-indigo-200 text-xs leading-relaxed">
                                        System detects increasing volume near the support level of ${selStock.low}. Momentum indicators suggest a potential breakout if resistance at ${selStock.high} is cleared. (Mock Data)
                                    </div>
                                </div>
                                <div className="p-3 bg-gray-800 border-t border-gray-700">
                                    <div className="relative">
                                        <input type="text" className="w-full bg-gray-900 border border-gray-600 rounded pl-3 pr-8 py-2 text-xs text-white focus:border-indigo-500 outline-none" placeholder="Ask about market trends..." />
                                        <Icons.Send size={14} className="absolute right-2 top-2.5 text-gray-500"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TOAST */}
                    {msg && (
                        <div className={`fixed top-16 right-4 px-4 py-3 rounded bg-gray-800 border-l-4 shadow-2xl text-sm font-bold flex items-center gap-3 z-[100] ${msg.type==='error'?'border-red-500 text-red-400':'border-green-500 text-green-400'}`}>
                            {msg.txt}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
